// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EGX Pro v14.0 ULTIMATE - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙØµØ­Ø­Ø© ÙˆØ§Ù„Ù…ÙØ­Ø³Ù‘Ù†Ø©
// Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 2025-01-15
// Build-Blockers Compliant âœ“ | RTL Safe âœ“ | No Repainting âœ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//@version=6
indicator("EGX Pro v14.0 ULTIMATE", 
     shorttitle="EGXv14", 
     overlay=true,
     max_labels_count=500, 
     max_lines_count=500, 
     max_boxes_count=120, 
     max_bars_back=5000)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¬Ø²Ø¡ 1/7: Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª + Ø§Ù„Ù„ØºØ© + Ø§Ù„Ø³ÙÙ…Ø§Øª + Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Constants (Ø«ÙˆØ§Ø¨Øª ØªØ¬Ù†Ø¨ Magic Numbers)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Setup Quality Weights
const int QUALITY_EMA_BULL_ABOVE = 25
const int QUALITY_EMA_BULL = 20
const float QUALITY_MTF_PER_TF = 4.16
const int QUALITY_VOL_EXTREME = 15
const int QUALITY_VOL_VHIGH = 12
const int QUALITY_VOL_BULL = 10
const int QUALITY_SUPPORT_TOUCH = 10
const int QUALITY_GOLDEN_ZONE = 5
const int QUALITY_RSI_ADX_BOTH = 10
const int QUALITY_RSI_ADX_SINGLE = 5
const int QUALITY_TRIGGER_MAJOR = 10
const int QUALITY_TRIGGER_MINOR = 5

// Trend Score Weights
const float TREND_EMA_BULL_ABOVE = 20.0
const float TREND_EMA_BULL = 15.0
const float TREND_EMA_BEAR_BELOW = -20.0
const float TREND_EMA_BEAR = -15.0
const float TREND_GOLDEN_CROSS = 12.0
const float TREND_DEATH_CROSS = -12.0
const float TREND_VWAP_ABOVE_STREAK = 8.0
const float TREND_VWAP_ABOVE = 5.0
const float TREND_VWAP_BELOW_STREAK = -8.0
const float TREND_VWAP_BELOW = -5.0

// Momentum Score Weights
const float MOM_RSI_BULL_ZONE = 12.0
const float MOM_RSI_BEAR_ZONE = -12.0
const float MOM_RSI_OVERSOLD = 10.0
const float MOM_RSI_OVERBOUGHT = -10.0
const float MOM_ADX_VERY_STRONG_BULL = 15.0
const float MOM_ADX_VERY_STRONG_BEAR = -15.0
const float MOM_ADX_STRONG_BULL = 10.0
const float MOM_ADX_STRONG_BEAR = -10.0
const float MOM_ADX_WEAK = -5.0
const float MOM_RSI_BULL_DIV = 8.0
const float MOM_RSI_BEAR_DIV = -8.0

// Volume Score Weights
const float VOL_BULL_EXTREME = 18.0
const float VOL_BULL_VHIGH = 15.0
const float VOL_BULL = 10.0
const float VOL_BEAR_EXTREME = -18.0
const float VOL_BEAR_VHIGH = -15.0
const float VOL_BEAR = -10.0
const float VOL_BUYING_FLOW = 10.0
const float VOL_SELLING_FLOW = -10.0
const float VOL_NET_PRESSURE_BULL = 8.0
const float VOL_NET_PRESSURE_BEAR = -8.0

// Probability Boosts
const float PROB_QUALITY_90 = 15.0
const float PROB_QUALITY_80 = 10.0
const float PROB_QUALITY_70 = 5.0
const float PROB_QUALITY_LOW = -10.0
const float PROB_MTF_ALL_BULL = 10.0
const float PROB_MTF_BEAR_HIGH = -15.0
const float PROB_REGIME_HEALTHY = 5.0
const float PROB_REGIME_POOR = -10.0
const float PROB_RR_HIGH = 5.0

// S/R Limits
const int MAX_SR_LEVELS = 100
const int SR_CLEANUP_PCT = 20

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_LANG = "ðŸŒ Ø§Ù„Ù„ØºØ© | Language"
msg_lang   = input.string("AR", "Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© | UI Language", 
     options=["AR","EN"], 
     group=G_LANG)
use_emojis = input.bool(true, "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ | Use Emojis", 
     group=G_LANG)

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø©
txt(string ar, string en) =>
    msg_lang == "AR" ? ar : en

// RTL Embedding
rtl_embed(string s) =>
    msg_lang == "AR" ? "â€Ž" + s : s

// Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ
to_align() =>
    msg_lang == "AR" ? text.align_right : text.align_left

to_align_center() =>
    text.align_center

// ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø­Ù„ RTL)
embed_number(float num, string format_str) =>
    string lrm = "\u200E"
    lrm + str.tostring(num, format_str) + lrm

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ø³ÙÙ…Ø§Øª (Themes)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_UI = "ðŸŽ¨ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø³Ù…Ø§Øª | UI & Themes"
ui_theme      = input.string("ØªØ¨Ø§ÙŠÙ† Ø¹Ø§Ù„Ù", "Ø§Ù„Ø³ÙÙ…Ø© | Theme", 
     options=["ØªØ¨Ø§ÙŠÙ† Ø¹Ø§Ù„Ù","Ø¯Ø§ÙƒÙ†","ÙØ§ØªØ­","Ù†ÙŠÙˆÙ†","Ø§Ø­ØªØ±Ø§ÙÙŠ"], 
     group=G_UI)
ui_colorblind = input.bool(false, "ÙˆØ¶Ø¹ Ø¢Ù…Ù† Ù„Ù„Ø£Ù„ÙˆØ§Ù† | Colorblind Safe", 
     group=G_UI)
compact_mode  = input.bool(false, "ÙˆØ¶Ø¹ Ù…Ø¶ØºÙˆØ· | Compact Mode", 
     group=G_UI)

var color PANEL_BG     = na
var color PANEL_BORDER = na
var color TEXT_MAIN    = na
var color TEXT_SUB     = na
var color GOOD         = na
var color BAD          = na
var color WARN         = na
var color INFO         = na
var color NEUTRAL      = na
var color ACCENT       = na
var color ACCENT2      = na

if barstate.isfirst
    if ui_theme == "ØªØ¨Ø§ÙŠÙ† Ø¹Ø§Ù„Ù"
        PANEL_BG     := color.rgb(20, 25, 35)
        PANEL_BORDER := color.rgb(99, 102, 241)
        TEXT_MAIN    := color.white
        TEXT_SUB     := color.rgb(203, 213, 225)
        GOOD         := ui_colorblind ? color.rgb(59,130,246) : color.rgb(16,185,129)
        BAD          := color.rgb(239,68,68)
        WARN         := color.rgb(245,158,11)
        INFO         := color.rgb(59,130,246)
        NEUTRAL      := color.rgb(100,116,139)
        ACCENT       := color.rgb(139,92,246)
        ACCENT2      := color.rgb(236,72,153)
    else if ui_theme == "Ø¯Ø§ÙƒÙ†"
        PANEL_BG     := color.rgb(17,24,39)
        PANEL_BORDER := color.rgb(75,85,99)
        TEXT_MAIN    := color.white
        TEXT_SUB     := color.rgb(156,163,175)
        GOOD         := ui_colorblind ? color.rgb(37,99,235) : color.rgb(34,197,94)
        BAD          := color.rgb(248,113,113)
        WARN         := color.rgb(251,191,36)
        INFO         := color.rgb(96,165,250)
        NEUTRAL      := color.rgb(148,163,184)
        ACCENT       := color.rgb(99,102,241)
        ACCENT2      := color.rgb(217,70,239)
    else if ui_theme == "Ù†ÙŠÙˆÙ†"
        PANEL_BG     := color.rgb(10,10,25)
        PANEL_BORDER := color.rgb(0,255,255)
        TEXT_MAIN    := color.rgb(0,255,255)
        TEXT_SUB     := color.rgb(255,0,255)
        GOOD         := color.rgb(0,255,127)
        BAD          := color.rgb(255,20,147)
        WARN         := color.rgb(255,215,0)
        INFO         := color.rgb(30,144,255)
        NEUTRAL      := color.rgb(138,43,226)
        ACCENT       := color.rgb(255,105,180)
        ACCENT2      := color.rgb(0,250,154)
    else if ui_theme == "Ø§Ø­ØªØ±Ø§ÙÙŠ"
        PANEL_BG     := color.rgb(30,33,38)
        PANEL_BORDER := color.rgb(82,139,255)
        TEXT_MAIN    := color.rgb(230,237,243)
        TEXT_SUB     := color.rgb(171,178,191)
        GOOD         := color.rgb(38,166,154)
        BAD          := color.rgb(239,83,80)
        WARN         := color.rgb(255,167,38)
        INFO         := color.rgb(66,165,245)
        NEUTRAL      := color.rgb(120,144,156)
        ACCENT       := color.rgb(126,87,194)
        ACCENT2      := color.rgb(255,112,67)
    else
        PANEL_BG     := color.rgb(248,250,252)
        PANEL_BORDER := color.rgb(148,163,184)
        TEXT_MAIN    := color.rgb(15,23,42)
        TEXT_SUB     := color.rgb(71,85,105)
        GOOD         := ui_colorblind ? color.rgb(37,99,235) : color.rgb(22,163,74)
        BAD          := color.rgb(220,38,38)
        WARN         := color.rgb(234,88,12)
        INFO         := color.rgb(37,99,235)
        NEUTRAL      := color.rgb(100,116,139)
        ACCENT       := color.rgb(109,40,217)
        ACCENT2      := color.rgb(219,39,119)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ù„ÙˆØ­Ø§Øª
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

to_pos(string s) =>
    p = position.bottom_center
    if s == "Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†" or s == "Top Right"
        p := position.top_right
    else if s == "Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±" or s == "Top Left"
        p := position.top_left
    else if s == "Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†" or s == "Bottom Right"
        p := position.bottom_right
    else if s == "Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±" or s == "Bottom Left"
        p := position.bottom_left
    else if s == "Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ³Ø·" or s == "Top Center"
        p := position.top_center
    else if s == "Ø£Ø³ÙÙ„ Ø§Ù„ÙˆØ³Ø·" or s == "Bottom Center"
        p := position.bottom_center
    p

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø§Øª (4 Ù„ÙˆØ­Ø§Øª ÙÙ‚Ø·)
show_control_panel     = input.bool(true,  "ðŸ§  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ | Control & Analysis", group=G_UI)
show_narrative_panel   = input.bool(true,  "ðŸ“‹ Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø±Ø¯ ÙˆØ§Ù„Ø®Ø·Ø© | Narrative & Plan", group=G_UI)
show_performance_panel = input.bool(true,  "ðŸ’¹ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± | Performance & Risk", group=G_UI)
show_reports_panel     = input.bool(true,  "ðŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„ | Reports & Legend", group=G_UI)

control_pos_str     = input.string("Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†", "Ù…ÙˆØ¶Ø¹ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Control Position", 
     options=["Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†","Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±","Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†","Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±"], 
     group=G_UI)
narrative_pos_str   = input.string("Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ³Ø·", "Ù…ÙˆØ¶Ø¹ Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø±Ø¯ | Narrative Position", 
     options=["Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ³Ø·","Ø£Ø³ÙÙ„ Ø§Ù„ÙˆØ³Ø·","Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†","Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±"], 
     group=G_UI)
performance_pos_str = input.string("Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†", "Ù…ÙˆØ¶Ø¹ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ | Performance Position", 
     options=["Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†","Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†","Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±"], 
     group=G_UI)
reports_pos_str     = input.string("Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±", "Ù…ÙˆØ¶Ø¹ Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± | Reports Position", 
     options=["Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±","Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†","Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±"], 
     group=G_UI)

control_pos     = to_pos(control_pos_str)
narrative_pos   = to_pos(narrative_pos_str)
performance_pos = to_pos(performance_pos_str)
reports_pos     = to_pos(reports_pos_str)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ·
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

to_font(string sz) =>
    string f = size.normal
    if sz == "ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹" or sz == "Tiny"
        f := size.tiny
    else if sz == "ØµØºÙŠØ±" or sz == "Small"
        f := size.small
    else if sz == "ÙˆØ³Ø·" or sz == "Medium"
        f := size.normal
    else if sz == "ÙƒØ¨ÙŠØ±" or sz == "Large"
        f := size.large
    f

control_font_in     = input.string("ØµØºÙŠØ±", "Ø®Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Control Font",   
     options=["ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹","ØµØºÙŠØ±","ÙˆØ³Ø·","ÙƒØ¨ÙŠØ±"], 
     group=G_UI)
narrative_font_in   = input.string("ØµØºÙŠØ±", "Ø®Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø±Ø¯ | Narrative Font",  
     options=["ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹","ØµØºÙŠØ±","ÙˆØ³Ø·","ÙƒØ¨ÙŠØ±"], 
     group=G_UI)
performance_font_in = input.string("ØµØºÙŠØ±", "Ø®Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ | Performance Font",    
     options=["ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹","ØµØºÙŠØ±","ÙˆØ³Ø·","ÙƒØ¨ÙŠØ±"], 
     group=G_UI)
reports_font_in     = input.string("ØµØºÙŠØ±", "Ø®Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± | Reports Font",     
     options=["ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹","ØµØºÙŠØ±","ÙˆØ³Ø·","ÙƒØ¨ÙŠØ±"], 
     group=G_UI)

var string control_font     = size.small
var string narrative_font   = size.small
var string performance_font = size.small
var string reports_font     = size.small

control_font     := to_font(control_font_in)
narrative_font   := to_font(narrative_font_in)
performance_font := to_font(performance_font_in)
reports_font     := to_font(reports_font_in)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (4 Ù„ÙˆØ­Ø§Øª)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var table control_table     = na
var table narrative_table   = na
var table performance_table = na
var table reports_table     = na

var string control_key     = ""
var string narrative_key   = ""
var string performance_key = ""
var string reports_key     = ""

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

round_tick(float p) =>
    float tick = syminfo.mintick
    tick := na(tick) or tick <= 0 ? 0.01 : tick
    math.round(p / tick) * tick

safe_div(float a, float b, float def) =>
    na(b) or b == 0 ? def : a / b

clean_hhmm(string s) =>
    string s1 = str.replace(s, ":", "")
    string s2 = str.replace(s1, ".", "")
    string s3 = str.replace(s2, " ", "")
    str.length(s3) == 3 ? "0" + s3 : s3

make_sess(string start_hhmm, string end_hhmm, string days) =>
    clean_hhmm(start_hhmm) + "-" + clean_hhmm(end_hhmm) + ":" + days

pad2(int n) =>
    n < 10 ? "0" + str.tostring(n) : str.tostring(n)

add_minutes(string hhmm, int mins) =>
    string s = clean_hhmm(hhmm)
    int hh = math.floor(str.tonumber(str.substring(s, 0, 2)))
    int mm = math.floor(str.tonumber(str.substring(s, 2, 4)))
    int tot = (hh * 60 + mm + mins) % (24 * 60)
    tot := tot < 0 ? tot + 24 * 60 : tot
    int nh = math.floor(tot / 60)
    int nm = tot % 60
    pad2(nh) + pad2(nm)

sec(string sym, string tf, series float expr) =>
    request.security(sym, tf, expr, 
         gaps=barmerge.gaps_off, 
         lookahead=barmerge.lookahead_off)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

get_month_ar(int m) =>
    string month_name = "Ø¯ÙŠØ³Ù…Ø¨Ø±"
    if m == 1
        month_name := "ÙŠÙ†Ø§ÙŠØ±"
    else if m == 2
        month_name := "ÙØ¨Ø±Ø§ÙŠØ±"
    else if m == 3
        month_name := "Ù…Ø§Ø±Ø³"
    else if m == 4
        month_name := "Ø£Ø¨Ø±ÙŠÙ„"
    else if m == 5
        month_name := "Ù…Ø§ÙŠÙˆ"
    else if m == 6
        month_name := "ÙŠÙˆÙ†ÙŠÙˆ"
    else if m == 7
        month_name := "ÙŠÙˆÙ„ÙŠÙˆ"
    else if m == 8
        month_name := "Ø£ØºØ³Ø·Ø³"
    else if m == 9
        month_name := "Ø³Ø¨ØªÙ…Ø¨Ø±"
    else if m == 10
        month_name := "Ø£ÙƒØªÙˆØ¨Ø±"
    else if m == 11
        month_name := "Ù†ÙˆÙÙ…Ø¨Ø±"
    month_name

get_current_date() =>
    string date_str = ""
    if msg_lang == "AR"
        string day_str = str.tostring(dayofmonth)
        string month_str = get_month_ar(month)
        string year_str = str.tostring(year)
        date_str := day_str + " " + month_str + " " + year_str
    else
        string day_str = str.tostring(dayofmonth)
        string month_str = str.tostring(month)
        string year_str = str.tostring(year)
        date_str := day_str + " " + month_str + " " + year_str
    date_str

get_timeframe_ar() =>
    string tf = timeframe.period
    string tf_ar = tf
    if msg_lang == "AR"
        if tf == "D"
            tf_ar := "ÙŠÙˆÙ…ÙŠ"
        else if tf == "W"
            tf_ar := "Ø£Ø³Ø¨ÙˆØ¹ÙŠ"
        else if tf == "M"
            tf_ar := "Ø´Ù‡Ø±ÙŠ"
        else if tf == "240"
            tf_ar := "4 Ø³Ø§Ø¹Ø§Øª"
        else if tf == "60"
            tf_ar := "Ø³Ø§Ø¹Ø©"
        else if tf == "15"
            tf_ar := "15 Ø¯Ù‚ÙŠÙ‚Ø©"
        else if tf == "5"
            tf_ar := "5 Ø¯Ù‚Ø§Ø¦Ù‚"
    else
        if tf == "D"
            tf_ar := "Daily"
        else if tf == "W"
            tf_ar := "Weekly"
        else if tf == "M"
            tf_ar := "Monthly"
    tf_ar
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±ÙŠØ¹Ø©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_SHARIA = "â˜ªï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø±ÙŠØ¹Ø© | Sharia Mode"
sharia_enabled   = input.bool(false, "ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø±ÙŠØ¹Ø© | Enable Sharia Mode", 
     group=G_SHARIA)
sharia_block_buy = input.bool(true, "Ø­Ø¬Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¥Ø°Ø§ ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚ | Block Buy if Non-Compliant", 
     group=G_SHARIA)
sharia_source    = input.string("ÙŠØ¯ÙˆÙŠ", "Ù…ØµØ¯Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© | List Source", 
     options=["ÙŠØ¯ÙˆÙŠ","Ù…Ø®ØªØµØ±Ø©","Ø´Ø§Ù…Ù„Ø©"], 
     group=G_SHARIA)
sharia_manual    = input.string("", "Ù‚Ø§Ø¦Ù…Ø© ÙŠØ¯ÙˆÙŠØ© (TickerIDs Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„) | Manual List", 
     group=G_SHARIA)
sharia_short     = input.string("EGX:ABUK,EGX:ADIB,EGX:SWDY,EGX:CIEB,EGX:HELI", 
     "Ù‚Ø§Ø¦Ù…Ø© Ù…Ø®ØªØµØ±Ø© | Short List", 
     group=G_SHARIA)
sharia_full      = input.string("", "Ù‚Ø§Ø¦Ù…Ø© Ø´Ø§Ù…Ù„Ø© | Full List", 
     group=G_SHARIA)

normalize_ticker(string s) =>
    string s1 = str.tostring(str.replace(str.replace(str.replace(s, " ", ""), "\n", ""), "\t", ""))
    str.upper(s1)

var string[] sharia_list = array.new_string()
if barstate.isfirst
    array.clear(sharia_list)
    string source_text = sharia_source == "ÙŠØ¯ÙˆÙŠ" ? sharia_manual : 
                         sharia_source == "Ù…Ø®ØªØµØ±Ø©" ? sharia_short : 
                         sharia_full
    if str.length(source_text) > 0
        string[] parts = str.split(source_text, ",")
        if array.size(parts) > 0
            for i = 0 to array.size(parts) - 1
                string sym = normalize_ticker(array.get(parts, i))
                if str.length(sym) > 0 and array.indexof(sharia_list, sym) == -1
                    array.push(sharia_list, sym)

string current_ticker = normalize_ticker(syminfo.tickerid)
bool is_sharia_compliant = true
if sharia_enabled and array.size(sharia_list) > 0
    is_sharia_compliant := false
    for i = 0 to array.size(sharia_list) - 1
        if current_ticker == array.get(sharia_list, i)
            is_sharia_compliant := true
            break

bool filter_sharia = not (sharia_enabled and sharia_block_buy and not is_sharia_compliant)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø¡ 1/7
// ØªÙ… Ø¥Ø¶Ø§ÙØ©:
// âœ… Constants (50+ Ø«Ø§Ø¨Øª)
// âœ… Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø© (txt + rtl_embed + embed_number)
// âœ… Ø§Ù„Ø³ÙÙ…Ø§Øª (5 Ø³ÙÙ…Ø§Øª)
// âœ… Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ù„ÙˆØ­Ø§Øª (4 Ù„ÙˆØ­Ø§Øª)
// âœ… Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ·
// âœ… Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (clean_hhmm, make_sess, sec, etc.)
// âœ… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
// âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±ÙŠØ¹Ø©
// 
// Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ø¬Ø²Ø¡ 2/7 (Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¬Ø²Ø¡ 2/7: Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ© (EMA, VWAP, RSI, ADX, ATR)
// v14.0 - Build-Blockers Safe âœ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù…ØµØ¯Ø± Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Confirmed Only - No Repainting)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

float o_src = sec(syminfo.tickerid, timeframe.period, open)
float h_src = sec(syminfo.tickerid, timeframe.period, high)
float l_src = sec(syminfo.tickerid, timeframe.period, low)
float c_src = sec(syminfo.tickerid, timeframe.period, close)
float v_src = sec(syminfo.tickerid, timeframe.period, volume)

// âœ… FIX: Ø¯Ø§Ø¦Ù…Ø§Ù‹ confirmed (Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø·)
float o = o_src[1]
float h = h_src[1]
float l = l_src[1]
float c = c_src[1]
float v = v_src[1]

float hlc3_custom = (h + l + c) / 3.0

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (EMA)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_EMA = "ðŸ“ˆ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© | Moving Averages"
use_ema       = input.bool(true,  "ØªÙØ¹ÙŠÙ„ EMA | Enable EMA", 
     group=G_EMA)
ema_fast_len  = input.int(20,  "EMA Ø³Ø±ÙŠØ¹ | Fast EMA",    
     minval=5,  maxval=50,  
     group=G_EMA)
ema_med_len   = input.int(50,  "EMA Ù…ØªÙˆØ³Ø· | Medium EMA", 
     minval=20, maxval=100, 
     group=G_EMA)
ema_slow_len  = input.int(150, "EMA Ø¨Ø·ÙŠØ¡ | Slow EMA",    
     minval=100,maxval=400, 
     group=G_EMA)
show_trend_bg = input.bool(false,"Ø®Ù„ÙÙŠØ© Ø§Ù„Ø§ØªØ¬Ø§Ù‡ | Trend Background", 
     group=G_EMA)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±ÙˆØ· (Build-Blockers Safe)
float ema_fast_all = ta.ema(c, ema_fast_len)
float ema_med_all  = ta.ema(c, ema_med_len)
float ema_slow_all = ta.ema(c, ema_slow_len)

float ema_fast = use_ema ? ema_fast_all : na
float ema_med  = use_ema ? ema_med_all  : na
float ema_slow = use_ema ? ema_slow_all : na

bool ema_bull_aligned = use_ema and ema_fast > ema_med and ema_med > ema_slow
bool ema_bear_aligned = use_ema and ema_fast < ema_med and ema_med < ema_slow

// âœ… FIX: ta.crossover Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
bool _golden_cross_raw = ta.crossover(ema_med_all,  ema_slow_all)
bool _death_cross_raw  = ta.crossunder(ema_med_all, ema_slow_all)
bool golden_cross = use_ema ? _golden_cross_raw : false
bool death_cross  = use_ema ? _death_cross_raw  : false

bool price_above_all_ema = use_ema and c > ema_fast and c > ema_med and c > ema_slow
bool price_below_all_ema = use_ema and c < ema_fast and c < ema_med and c < ema_slow

plot(ema_fast, 
     txt("EMA Ø³Ø±ÙŠØ¹","EMA Fast"),  
     color.rgb(33,150,243), 
     2, 
     display=use_ema ? display.all : display.none)
plot(ema_med,  
     txt("EMA Ù…ØªÙˆØ³Ø·","EMA Med"),  
     color.rgb(255,152,0),  
     2, 
     display=use_ema ? display.all : display.none)
plot(ema_slow, 
     txt("EMA Ø¨Ø·ÙŠØ¡","EMA Slow"), 
     color.rgb(233,30,99),  
     3, 
     display=use_ema ? display.all : display.none)

color trend_bg = na
if show_trend_bg
    if ema_bull_aligned
        trend_bg := color.new(GOOD, 92)
    else if ema_bear_aligned
        trend_bg := color.new(BAD, 92)
bgcolor(trend_bg, title=txt("Ø®Ù„ÙÙŠØ© Ø§Ù„Ø§ØªØ¬Ø§Ù‡","Trend BG"))

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VWAP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

use_vwap = input.bool(true, "ØªÙØ¹ÙŠÙ„ VWAP | Enable VWAP", 
     group=G_EMA)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float vwap_all = ta.vwap(hlc3_custom)
float vwap_val = use_vwap ? vwap_all : na
bool  vwap_active = use_vwap and not na(vwap_val)

bool above_vwap = vwap_active and c > vwap_val
bool below_vwap = vwap_active and c < vwap_val

var int streak_below_vwap = 0
var int streak_above_vwap = 0
if vwap_active
    streak_below_vwap := below_vwap ? nz(streak_below_vwap[1], 0) + 1 : 0
    streak_above_vwap := above_vwap ? nz(streak_above_vwap[1], 0) + 1 : 0

plot(vwap_val, 
     "VWAP",   
     color.yellow, 
     2, 
     plot.style_circles, 
     display=use_vwap ? display.all : display.none)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RSI (Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù†Ø³Ø¨ÙŠØ©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_RSI = txt("ðŸ’ª Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù†Ø³Ø¨ÙŠØ©", "ðŸ’ª RSI Indicator")
use_rsi    = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ RSI","Enable RSI"), 
     group=G_RSI)
rsi_length = input.int(14, txt("Ø§Ù„Ø·ÙˆÙ„","Length"), 
     minval=7, maxval=28, 
     group=G_RSI)
rsi_ob     = input.int(70, txt("ØªØ´Ø¨Ø¹ Ø´Ø±Ø§Ø¦ÙŠ","Overbought"), 
     minval=65, maxval=85, 
     group=G_RSI)
rsi_os     = input.int(30, txt("ØªØ´Ø¨Ø¹ Ø¨ÙŠØ¹ÙŠ","Oversold"),  
     minval=15, maxval=35, 
     group=G_RSI)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float rsi_all = ta.rsi(c, rsi_length)
float rsi_val = use_rsi ? rsi_all : 50.0

bool rsi_overbought   = rsi_val > rsi_ob
bool rsi_oversold     = rsi_val < rsi_os
bool rsi_bullish_zone = rsi_val > 50 and rsi_val < rsi_ob
bool rsi_bearish_zone = rsi_val < 50 and rsi_val > rsi_os

// RSI Divergence
bool rsi_bullish_div = false
bool rsi_bearish_div = false
float rsi_pivot_low  = ta.pivotlow(rsi_all, 5, 5)
float rsi_pivot_high = ta.pivothigh(rsi_all, 5, 5)
if use_rsi
    if not na(rsi_pivot_low) and bar_index >= 5
        rsi_bullish_div := c < nz(c[5], c) and rsi_all > nz(rsi_all[5], rsi_all)
    if not na(rsi_pivot_high) and bar_index >= 5
        rsi_bearish_div := c > nz(c[5], c) and rsi_all < nz(rsi_all[5], rsi_all)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ADX (Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø§ØªØ¬Ø§Ù‡ÙŠØ©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_ADX = txt("ðŸ”¥ Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø§ØªØ¬Ø§Ù‡ÙŠØ©", "ðŸ”¥ ADX Indicator")
use_adx       = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ ADX","Enable ADX"), 
     group=G_ADX)
adx_length    = input.int(14, txt("Ø§Ù„Ø·ÙˆÙ„","Length"), 
     minval=7, maxval=28, 
     group=G_ADX)
adx_threshold = input.int(20, txt("Ø­Ø¯ Ø§Ù„Ù‚ÙˆØ©","Strength Threshold"), 
     minval=15, maxval=40, 
     group=G_ADX)

// âœ… FIX: Ø­Ø³Ø§Ø¨ ÙƒØ§Ù…Ù„ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±ÙˆØ·
float prev_high = nz(h[1], h)
float prev_low  = nz(l[1], l)
float prev_close= nz(c[1], c)

float tr_val    = math.max(h - l, math.max(math.abs(h - prev_close), math.abs(l - prev_close)))
float up_move   = h - prev_high
float down_move = prev_low - l

float dm_plus   = (up_move > down_move and up_move > 0) ? up_move  : 0.0
float dm_minus  = (down_move > up_move and down_move > 0) ? down_move: 0.0

float tr_smooth       = ta.rma(tr_val, adx_length)
float dm_plus_smooth  = ta.rma(dm_plus, adx_length)
float dm_minus_smooth = ta.rma(dm_minus, adx_length)

float di_plus  = 100.0 * safe_div(dm_plus_smooth,  tr_smooth, 0.0)
float di_minus = 100.0 * safe_div(dm_minus_smooth, tr_smooth, 0.0)

float dx      = 100.0 * safe_div(math.abs(di_plus - di_minus), (di_plus + di_minus), 0.0)
float adx_all = ta.rma(dx, adx_length)
float adx_val = use_adx ? adx_all : 20.0

bool adx_weak        = adx_val < 20
bool adx_moderate    = adx_val >= 20 and adx_val < 30
bool adx_strong      = adx_val >= adx_threshold
bool adx_very_strong = adx_val >= adx_threshold + 15

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ATR (Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_ATR = txt("ðŸ“ Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ", "ðŸ“ Average True Range")
atr_period = input.int(14, txt("Ø§Ù„ÙØªØ±Ø©","Period"), 
     minval=7, maxval=28, 
     group=G_ATR)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float atr_all  = ta.atr(atr_period)
float atr_val  = atr_all
float atr_safe = math.max(atr_val, syminfo.mintick * 10.0)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø³ÙŠÙˆÙ„Ø© (Volume & Liquidity)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_VOL = txt("ðŸ“Š Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø³ÙŠÙˆÙ„Ø©", "ðŸ“Š Volume & Liquidity")
use_volume  = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…","Enable Volume Analysis"), 
     group=G_VOL)
vol_sma_len = input.int(20, txt("Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ù…","Volume SMA"), 
     minval=10, maxval=50, 
     group=G_VOL)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float v_sma20 = ta.sma(v, 20)
float vol_sma = ta.sma(v, vol_sma_len)

enable_liquidity_filter = input.bool(true, txt("ÙÙ„ØªØ± Ø§Ù„Ø³ÙŠÙˆÙ„Ø©","Liquidity Filter"), 
     group=G_VOL)
liquidity_preset = input.string("ÙƒØ¨ÙŠØ±Ø©", txt("Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©","Liquidity Level"),
     options=["ØµØºÙŠØ±Ø©","Ù…ØªÙˆØ³Ø·Ø©","ÙƒØ¨ÙŠØ±Ø©","Ø¶Ø®Ù…Ø©","Ù…Ø®ØµØµ"], 
     group=G_VOL)
min_value_custom    = input.float(3.0e6, txt("Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù…Ø®ØµØµ (Ø¬.Ù…)","Min Value Custom (EGP)"), 
     step=1e5, 
     group=G_VOL)
max_bar_range_pct   = input.float(6.0, txt("Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø´Ù…Ø¹Ø© %","Max Bar Range %"), 
     step=0.5, 
     group=G_VOL)
spread_atr_cap_mult = input.float(3.0, txt("Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†Ø·Ø§Ù‚ (xATR)","Max Range (xATR)"), 
     step=0.5, 
     minval=1.0, 
     maxval=6.0, 
     group=G_VOL)
use_daily_value     = input.bool(true, txt("Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ","Use Daily Value"), 
     group=G_VOL)

float min_value_threshold = 0.0
if liquidity_preset == "ØµØºÙŠØ±Ø©"
    min_value_threshold := 1.5e6
else if liquidity_preset == "Ù…ØªÙˆØ³Ø·Ø©"
    min_value_threshold := 3.0e6
else if liquidity_preset == "ÙƒØ¨ÙŠØ±Ø©"
    min_value_threshold := 6.0e6
else if liquidity_preset == "Ø¶Ø®Ù…Ø©"
    min_value_threshold := 12.0e6
else
    min_value_threshold := min_value_custom

// Order Flow (ØªØ¯ÙÙ‚ Ø§Ù„Ø£ÙˆØ§Ù…Ø±)
float candle_range  = h - l
float buy_pressure  = candle_range > 0 ? safe_div((c - l), candle_range, 0.0) * v : 0.0
float sell_pressure = candle_range > 0 ? safe_div((h - c), candle_range, 0.0) * v : 0.0
float net_pressure  = buy_pressure - sell_pressure

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float buy_pressure_ma  = ta.sma(buy_pressure, 20)
float sell_pressure_ma = ta.sma(sell_pressure, 20)
bool  strong_buying_flow  = buy_pressure_ma  > sell_pressure_ma * 1.5
bool  strong_selling_flow = sell_pressure_ma > buy_pressure_ma  * 1.5

bool vol_high      = v > vol_sma * 1.5
bool vol_very_high = v > vol_sma * 2.5
bool vol_extreme   = v > vol_sma * 4.0

bool vol_bullish = vol_high and c > o and net_pressure > 0
bool vol_bearish = vol_high and c < o and net_pressure < 0

float traded_value_current = c * v
float traded_value_sma     = ta.sma(traded_value_current, 20)
float traded_value_daily   = use_daily_value ? sec(syminfo.tickerid, "D", ta.sma(close * volume, 20))[1] : na
float effective_value      = use_daily_value and not na(traded_value_daily) ? traded_value_daily : traded_value_sma

float bar_range_percent = c > 0 ? ((h - l) / c) * 100.0 : 0.0
bool liquidity_condition = (effective_value >= min_value_threshold and bar_range_percent <= max_bar_range_pct)
bool liquidity_ok        = not enable_liquidity_filter or liquidity_condition
bool spread_ok           = (h - l) <= atr_safe * spread_atr_cap_mult

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù†Ø³Ø¨ÙŠØ© ÙˆØ§Ù„Ø§Ø±ØªØ¨Ø§Ø· (RS & Correlation)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_RS = txt("ðŸ’Ž Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù†Ø³Ø¨ÙŠØ©", "ðŸ’Ž Relative Strength")
use_rs              = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ RS","Enable RS"), 
     group=G_RS)
benchmark_primary   = input.string("EGX:EGX30",    txt("Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ","Benchmark Index"), 
     group=G_RS)
benchmark_secondary = input.string("EGX:EGX70EWI", txt("Ù…Ø¤Ø´Ø± Ø¨Ø¯ÙŠÙ„","Fallback Index"),       
     group=G_RS)
use_auto_fallback   = input.bool(true, txt("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹","Auto Fallback"), 
     group=G_RS)

enable_correlation = input.bool(false, txt("ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ± Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·","Correlation Filter"), 
     group=G_RS)
correlation_period = input.int(20, txt("ÙØªØ±Ø© Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·","Correlation Period"), 
     minval=10, maxval=50, 
     group=G_RS)
min_correlation    = input.float(0.3, txt("Ø­Ø¯ Ø£Ø¯Ù†Ù‰ |Ï|","Min |Ï|"), 
     step=0.1, 
     minval=-1.0, 
     maxval=1.0, 
     group=G_RS)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float bench_close_1 = use_rs ? sec(benchmark_primary, timeframe.period, close)   : na
float bench_close_2 = use_rs ? sec(benchmark_secondary, timeframe.period, close) : na

float bench_close = na
if use_rs
    if not na(bench_close_1)
        bench_close := bench_close_1
    else if use_auto_fallback
        bench_close := bench_close_2

float rs_ratio   = use_rs and not na(bench_close) and bench_close > 0 ? c / bench_close : na
float rs_ema_20a = ta.ema(rs_ratio, 20)
float rs_ema_50a = ta.ema(rs_ratio, 50)
float rs_ema_20  = use_rs ? rs_ema_20a : na
float rs_ema_50  = use_rs ? rs_ema_50a : na

bool rs_trend_bullish = use_rs and not na(rs_ema_20) and not na(rs_ema_50) and rs_ema_20 > rs_ema_50
bool rs_trend_bearish = use_rs and not na(rs_ema_20) and not na(rs_ema_50) and rs_ema_20 < rs_ema_50

float correlation_raw = ta.correlation(c, bench_close, correlation_period)
float correlation_val = (enable_correlation and use_rs and not na(bench_close)) ? correlation_raw : na
bool  correlation_weak = enable_correlation and not na(correlation_val) and math.abs(correlation_val) < min_correlation

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MACD (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_MACD = txt("ðŸŒŠ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø§ÙƒØ¯", "ðŸŒŠ MACD Indicator")
use_macd    = input.bool(false, txt("ØªÙØ¹ÙŠÙ„ MACD","Enable MACD"), 
     group=G_MACD)
macd_fast   = input.int(12, txt("Ø³Ø±ÙŠØ¹","Fast"),   
     minval=5,  maxval=50,  
     group=G_MACD)
macd_slow   = input.int(26, txt("Ø¨Ø·ÙŠØ¡","Slow"),   
     minval=10, maxval=100, 
     group=G_MACD)
macd_signal = input.int(9,  txt("Ø§Ù„Ø¥Ø´Ø§Ø±Ø©","Signal"), 
     minval=3, maxval=30, 
     group=G_MACD)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float macd_line_all      = ta.ema(c, macd_fast) - ta.ema(c, macd_slow)
float macd_signal_line_a = ta.ema(macd_line_all, macd_signal)
float macd_hist_all      = macd_line_all - macd_signal_line_a

float macd_line        = use_macd ? macd_line_all      : na
float macd_signal_line = use_macd ? macd_signal_line_a : na
float macd_histogram   = use_macd ? macd_hist_all      : na

// âœ… FIX: ta.crossover Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
bool _macd_cross_up_raw   = ta.crossover(macd_line_all,  macd_signal_line_a)
bool _macd_cross_down_raw = ta.crossunder(macd_line_all, macd_signal_line_a)
bool macd_bullish = use_macd ? _macd_cross_up_raw   and macd_histogram > 0 : false
bool macd_bearish = use_macd ? _macd_cross_down_raw and macd_histogram < 0 : false

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø¡ 2/7
// ØªÙ… Ø¥Ø¶Ø§ÙØ©:
// âœ… Ù…ØµØ¯Ø± Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Confirmed Only - No Repainting)
// âœ… EMA (3 Ù…ØªÙˆØ³Ø·Ø§Øª + Golden/Death Cross)
// âœ… VWAP (Ù…Ø¹ Streaks)
// âœ… RSI (Ù…Ø¹ Divergence)
// âœ… ADX (Ù…Ø¹ DI+/DI-)
// âœ… ATR (Ø¢Ù…Ù†)
// âœ… Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø³ÙŠÙˆÙ„Ø© (Order Flow + Liquidity Filter)
// âœ… Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù†Ø³Ø¨ÙŠØ© (RS + Correlation)
// âœ… MACD (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
// 
// ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±ÙˆØ· (Build-Blockers Safe âœ“)
// 
// Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ø¬Ø²Ø¡ 3/7 (MTF + Regime + Sessions)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¬Ø²Ø¡ 3/7: Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø·Ø± + Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙˆÙ‚ + Ø§Ù„Ø¬Ù„Ø³Ø§Øª
// v14.0 - Build-Blockers Safe âœ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø¬Ù„Ø³Ø§Øª EGX (Egyptian Exchange Sessions)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_SESSION   = txt("ðŸ•’ Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø¨ÙˆØ±ØµØ© Ø§Ù„Ù…ØµØ±ÙŠØ©", "ðŸ•’ EGX Sessions")
session_days       = input.string("23456", txt("Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„","Working Days"), 
     group=G_SESSION,
     tooltip="1=Ø§Ù„Ø£Ø­Ø¯, 2=Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†, 3=Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡, 4=Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡, 5=Ø§Ù„Ø®Ù…ÙŠØ³, 6=Ø§Ù„Ø¬Ù…Ø¹Ø©, 7=Ø§Ù„Ø³Ø¨Øª")
pre_open_start     = input.string("0930", txt("Ø¨Ø¯Ø§ÙŠØ© Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø§ÙØªØªØ§Ø­","Pre-Open Start"), 
     group=G_SESSION)
pre_open_end       = input.string("1000", txt("Ù†Ù‡Ø§ÙŠØ© Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø§ÙØªØªØ§Ø­","Pre-Open End"), 
     group=G_SESSION)
opening_start      = input.string("1000", txt("Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§ÙØªØªØ§Ø­","Opening Start"), 
     group=G_SESSION)
opening_end        = input.string("1015", txt("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§ÙØªØªØ§Ø­","Opening End"), 
     group=G_SESSION)
regular_start      = input.string("1015", txt("Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©","Regular Start"), 
     group=G_SESSION)
regular_end        = input.string("1415", txt("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©","Regular End"), 
     group=G_SESSION)
closing_start      = input.string("1415", txt("Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚","Closing Start"), 
     group=G_SESSION)
closing_end        = input.string("1430", txt("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©","Closing End"), 
     group=G_SESSION)
allow_preopen      = input.bool(false, txt("Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙÙŠ Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø§ÙØªØªØ§Ø­","Allow Pre-Open Trading"), 
     group=G_SESSION)
avoid_opening_mins = input.int(15, txt("ØªØ¬Ù†Ù‘Ø¨ Ø£ÙˆÙ„ N Ø¯Ù‚ÙŠÙ‚Ø©","Avoid First N Minutes"), 
     minval=0, maxval=90, 
     group=G_SESSION)
avoid_closing_mins = input.int(10, txt("ØªØ¬Ù†Ù‘Ø¨ Ø¢Ø®Ø± N Ø¯Ù‚ÙŠÙ‚Ø©","Avoid Last N Minutes"), 
     minval=0, maxval=90, 
     group=G_SESSION)

in_preopen = not na(time(timeframe.period, make_sess(pre_open_start, pre_open_end, session_days)))
in_opening = not na(time(timeframe.period, make_sess(opening_start, opening_end, session_days)))
in_regular = not na(time(timeframe.period, make_sess(regular_start, regular_end, session_days)))
in_closing = not na(time(timeframe.period, make_sess(closing_start, closing_end, session_days)))

bool in_any_session = in_preopen or in_opening or in_regular or in_closing
bool in_auction     = in_preopen or in_opening or in_closing
bool filter_session = allow_preopen ? in_any_session : (in_opening or in_regular or in_closing)

string avoid_open  = make_sess(opening_start, add_minutes(opening_start, avoid_opening_mins), session_days)
string avoid_close = make_sess(add_minutes(closing_end, -avoid_closing_mins), closing_end, session_days)

bool in_avoid_opening = avoid_opening_mins > 0 and not na(time(timeframe.period, avoid_open))
bool in_avoid_closing = avoid_closing_mins > 0 and not na(time(timeframe.period, avoid_close))
bool filter_time_window = not (in_avoid_opening or in_avoid_closing)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø·Ø± (Multi-Timeframe Analysis)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_MTF = txt("ðŸ”„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø·Ø±", "ðŸ”„ Multi-Timeframe Analysis")
use_mtf = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ MTF","Enable MTF"), 
     group=G_MTF)
htf_1 = input.timeframe("15",  txt("Ø¥Ø·Ø§Ø± 1","Timeframe 1"), 
     group=G_MTF)
htf_2 = input.timeframe("60",  txt("Ø¥Ø·Ø§Ø± 2","Timeframe 2"), 
     group=G_MTF)
htf_3 = input.timeframe("240", txt("Ø¥Ø·Ø§Ø± 3","Timeframe 3"), 
     group=G_MTF)
htf_4 = input.timeframe("D",   txt("Ø¥Ø·Ø§Ø± 4","Timeframe 4"), 
     group=G_MTF)
htf_5 = input.timeframe("W",   txt("Ø¥Ø·Ø§Ø± 5","Timeframe 5"), 
     group=G_MTF)
htf_6 = input.timeframe("M",   txt("Ø¥Ø·Ø§Ø± 6","Timeframe 6"), 
     group=G_MTF)
mtf_min_alignment = input.int(3, txt("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªÙˆØ§ÙÙ‚","Min Alignment"), 
     minval=2, maxval=6, 
     group=G_MTF)

mtf_ok(string tf) =>
    timeframe.in_seconds(tf) >= timeframe.in_seconds(timeframe.period)

// âœ… FIX: ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±ÙˆØ·
float mtf_ema_med_1  = use_mtf and mtf_ok(htf_1) ? sec(syminfo.tickerid, htf_1, ta.ema(close, ema_med_len))  : na
float mtf_ema_slow_1 = use_mtf and mtf_ok(htf_1) ? sec(syminfo.tickerid, htf_1, ta.ema(close, ema_slow_len)) : na
float mtf_ema_med_2  = use_mtf and mtf_ok(htf_2) ? sec(syminfo.tickerid, htf_2, ta.ema(close, ema_med_len))  : na
float mtf_ema_slow_2 = use_mtf and mtf_ok(htf_2) ? sec(syminfo.tickerid, htf_2, ta.ema(close, ema_slow_len)) : na
float mtf_ema_med_3  = use_mtf and mtf_ok(htf_3) ? sec(syminfo.tickerid, htf_3, ta.ema(close, ema_med_len))  : na
float mtf_ema_slow_3 = use_mtf and mtf_ok(htf_3) ? sec(syminfo.tickerid, htf_3, ta.ema(close, ema_slow_len)) : na
float mtf_ema_med_4  = use_mtf and mtf_ok(htf_4) ? sec(syminfo.tickerid, htf_4, ta.ema(close, ema_med_len))  : na
float mtf_ema_slow_4 = use_mtf and mtf_ok(htf_4) ? sec(syminfo.tickerid, htf_4, ta.ema(close, ema_slow_len)) : na
float mtf_ema_med_5  = use_mtf and mtf_ok(htf_5) ? sec(syminfo.tickerid, htf_5, ta.ema(close, ema_med_len))  : na
float mtf_ema_slow_5 = use_mtf and mtf_ok(htf_5) ? sec(syminfo.tickerid, htf_5, ta.ema(close, ema_slow_len)) : na
float mtf_ema_med_6  = use_mtf and mtf_ok(htf_6) ? sec(syminfo.tickerid, htf_6, ta.ema(close, ema_med_len))  : na
float mtf_ema_slow_6 = use_mtf and mtf_ok(htf_6) ? sec(syminfo.tickerid, htf_6, ta.ema(close, ema_slow_len)) : na

int mtf_trend_1 = 0
int mtf_trend_2 = 0
int mtf_trend_3 = 0
int mtf_trend_4 = 0
int mtf_trend_5 = 0
int mtf_trend_6 = 0
if use_mtf
    mtf_trend_1 := not na(mtf_ema_med_1) and not na(mtf_ema_slow_1) ? (mtf_ema_med_1 > mtf_ema_slow_1 ? 1 : -1) : 0
    mtf_trend_2 := not na(mtf_ema_med_2) and not na(mtf_ema_slow_2) ? (mtf_ema_med_2 > mtf_ema_slow_2 ? 1 : -1) : 0
    mtf_trend_3 := not na(mtf_ema_med_3) and not na(mtf_ema_slow_3) ? (mtf_ema_med_3 > mtf_ema_slow_3 ? 1 : -1) : 0
    mtf_trend_4 := not na(mtf_ema_med_4) and not na(mtf_ema_slow_4) ? (mtf_ema_med_4 > mtf_ema_slow_4 ? 1 : -1) : 0
    mtf_trend_5 := not na(mtf_ema_med_5) and not na(mtf_ema_slow_5) ? (mtf_ema_med_5 > mtf_ema_slow_5 ? 1 : -1) : 0
    mtf_trend_6 := not na(mtf_ema_med_6) and not na(mtf_ema_slow_6) ? (mtf_ema_med_6 > mtf_ema_slow_6 ? 1 : -1) : 0

int mtf_bullish_count = (mtf_trend_1 > 0 ? 1 : 0) + (mtf_trend_2 > 0 ? 1 : 0) + (mtf_trend_3 > 0 ? 1 : 0) + (mtf_trend_4 > 0 ? 1 : 0) + (mtf_trend_5 > 0 ? 1 : 0) + (mtf_trend_6 > 0 ? 1 : 0)
int mtf_bearish_count = (mtf_trend_1 < 0 ? 1 : 0) + (mtf_trend_2 < 0 ? 1 : 0) + (mtf_trend_3 < 0 ? 1 : 0) + (mtf_trend_4 < 0 ? 1 : 0) + (mtf_trend_5 < 0 ? 1 : 0) + (mtf_trend_6 < 0 ? 1 : 0)

bool mtf_aligned_bullish = use_mtf and mtf_bullish_count >= mtf_min_alignment
bool mtf_aligned_bearish = use_mtf and mtf_bearish_count >= mtf_min_alignment
bool mtf_all_bullish     = use_mtf and mtf_bullish_count == 6
bool mtf_all_bearish     = use_mtf and mtf_bearish_count == 6

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙˆÙ‚ (Market Regime Detection)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_REGIME = txt("ðŸŒ¡ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙˆÙ‚", "ðŸŒ¡ï¸ Market Regime")
enable_regime_filter = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ù†Ø¸Ø§Ù…","Enable Regime Detection"), 
     group=G_REGIME)
regime_lookback      = input.int(50, txt("Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…","Lookback Period"), 
     minval=20, maxval=200, 
     group=G_REGIME)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float atr_ma_long = ta.sma(atr_val, regime_lookback)
float atr_ratio   = safe_div(atr_val, atr_ma_long, 1.0)

string market_regime = txt("Ø·Ø¨ÙŠØ¹ÙŠ","Normal")
if atr_ratio > 1.5 and adx_val > 30
    market_regime := txt("ØªÙ‚Ù„Ø¨ Ø¹Ø§Ù„Ù Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡","High Volatility Trending")
else if atr_ratio > 1.5 and adx_val < 20
    market_regime := txt("ØªÙ‚Ù„Ø¨ Ø¹Ø§Ù„Ù Ø¨Ù„Ø§ Ø§ØªØ¬Ø§Ù‡","High Volatility Ranging")
else if atr_ratio < 0.7 and adx_val < 15
    market_regime := txt("ØªÙ‚Ù„Ø¨ Ù…Ù†Ø®ÙØ¶","Low Volatility")
else if atr_ratio < 0.7 and adx_val >= 20
    market_regime := txt("ØªÙ‚Ù„Ø¨ Ù…Ù†Ø®ÙØ¶ Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡","Low Volatility Trending")

bool regime_allows_trade = not enable_regime_filter or (market_regime != txt("ØªÙ‚Ù„Ø¨ Ø¹Ø§Ù„Ù Ø¨Ù„Ø§ Ø§ØªØ¬Ø§Ù‡","High Volatility Ranging") and market_regime != txt("ØªÙ‚Ù„Ø¨ Ù…Ù†Ø®ÙØ¶","Low Volatility"))
bool regime_is_healthy   = market_regime == txt("Ø·Ø¨ÙŠØ¹ÙŠ","Normal") or market_regime == txt("ØªÙ‚Ù„Ø¨ Ø¹Ø§Ù„Ù Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡","High Volatility Trending") or market_regime == txt("ØªÙ‚Ù„Ø¨ Ù…Ù†Ø®ÙØ¶ Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡","Low Volatility Trending")

bool dead_market       = atr_val < ta.lowest(atr_val, 50) * 1.1 and v < vol_sma * 0.6
bool volatile_extreme  = atr_ratio > 2.0 and bar_range_percent > 8.0
bool volatility_filter_ok = not dead_market and not volatile_extreme

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Stock Profile Classifier (ØªØµÙ†ÙŠÙ Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

classify_stock_profile(float adx, float atr_r) =>
    string profile = ""
    color prof_col = NEUTRAL
    if adx >= 30 and atr_r > 1.3
        profile := txt("ØªØ±Ù†Ø¯ Ù‚ÙˆÙŠ Ù…ØªÙ‚Ù„Ø¨", "Strong Trending Volatile")
        prof_col := color.orange
    else if adx >= 25 and atr_r <= 1.0
        profile := txt("ØªØ±Ù†Ø¯ Ù…Ø³ØªÙ‚Ø±", "Stable Trending")
        prof_col := GOOD
    else if adx < 20 and atr_r < 0.8
        profile := txt("Ù†Ø·Ø§Ù‚ Ø¶ÙŠÙ‚", "Tight Range")
        prof_col := NEUTRAL
    else if atr_r > 1.5
        profile := txt("Ù…ØªÙ‚Ù„Ø¨ Ø¨Ù„Ø§ Ø§ØªØ¬Ø§Ù‡", "Choppy Volatile")
        prof_col := BAD
    else
        profile := txt("Ù…Ø­Ø§ÙŠØ¯", "Neutral")
        prof_col := INFO
    [profile, prof_col]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨ØµØ±ÙŠØ© (Visual Helpers)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

get_score_gauge(float score, int max_width) =>
    float normalized = math.max(0.0, math.min(1.0, (score + 100.0) / 200.0))
    int filled = int(math.round(normalized * max_width))
    string gauge = ""
    for i = 0 to max_width - 1
        if i < filled
            if score >= 70
                gauge += use_emojis ? "ðŸŸ¢" : "â–ˆ"
            else if score >= 40
                gauge += use_emojis ? "ðŸŸ¡" : "â–“"
            else if score >= 0
                gauge += use_emojis ? "ðŸŸ " : "â–’"
            else
                gauge += use_emojis ? "ðŸ”´" : "â–‘"
        else
            gauge += use_emojis ? "âšª" : "â–‘"
    gauge

draw_progress_bar(float value, float max_val, int width) =>
    float pct = safe_div(value, max_val, 0.0)
    int filled = int(math.round(pct * width))
    string bar = ""
    for i = 0 to width - 1
        bar += i < filled ? "â–ˆ" : "â–‘"
    bar

get_support_stars() =>
    string stars = ""
    if not na(nearest_support) and not na(support_effective_strength)
        if support_effective_strength >= 8.0
            stars := use_emojis ? "â­â­â­" : "***"
        else if support_effective_strength >= 5.0
            stars := use_emojis ? "â­â­" : "**"
        else if support_effective_strength >= 3.0
            stars := use_emojis ? "â­" : "*"
    stars

get_market_temp(bool volatile_ex, float atr_r, bool dead_mkt) =>
    string temp = ""
    color temp_col = NEUTRAL
    if volatile_ex
        temp := (use_emojis ? "ðŸ”¥ " : "") + txt("Ø³Ø§Ø®Ù† Ø¬Ø¯Ø§Ù‹", "Too Hot")
        temp_col := BAD
    else if atr_r > 1.3
        temp := (use_emojis ? "âš¡ " : "") + txt("Ù…ØªÙ‚Ù„Ø¨", "Volatile")
        temp_col := WARN
    else if dead_mkt
        temp := (use_emojis ? "ðŸ§Š " : "") + txt("Ù…ÙŠØª", "Dead")
        temp_col := NEUTRAL
    else
        temp := (use_emojis ? "âœ… " : "") + txt("Ø·Ø¨ÙŠØ¹ÙŠ", "Normal")
        temp_col := GOOD
    [temp, temp_col]

calc_signal_strength(bool ema_bull, bool mtf_bull, bool adx_str, bool vol_bull, bool sr_touch, bool rsi_bull, bool trig) =>
    int strength = 0
    if ema_bull
        strength += 2
    if mtf_bull
        strength += 2
    if adx_str
        strength += 1
    if vol_bull
        strength += 1
    if sr_touch
        strength += 2
    if rsi_bull
        strength += 1
    if trig
        strength += 1
    strength

get_signal_strength_bar(int strength, int max_str) =>
    string bar = ""
    for i = 0 to max_str - 1
        bar += i < strength ? "â–ˆ" : "â–‘"
    bar + " (" + str.tostring(strength) + "/" + str.tostring(max_str) + ")"

get_risk_gauge(float heat_pct) =>
    string gauge = ""
    color col = NEUTRAL
    if heat_pct <= 1.0
        gauge := (use_emojis ? "ðŸŸ¢ " : "") + txt("Ù…Ù†Ø®ÙØ¶", "Low")
        col := GOOD
    else if heat_pct <= 2.0
        gauge := (use_emojis ? "ðŸŸ¡ " : "") + txt("Ù…ØªÙˆØ³Ø·", "Medium")
        col := WARN
    else if heat_pct <= 3.0
        gauge := (use_emojis ? "ðŸŸ  " : "") + txt("Ù…Ø±ØªÙØ¹", "High")
        col := color.orange
    else
        gauge := (use_emojis ? "ðŸ”´ " : "") + txt("Ø®Ø·ÙŠØ±", "Critical")
        col := BAD
    [gauge, col]

get_exposure_graph(float exp_pct, int width) =>
    int filled = int(exp_pct / 10)
    filled := math.min(filled, width)
    string graph = ""
    for i = 0 to width - 1
        graph += i < filled ? "â–ˆ" : "â–‘"
    graph + " " + embed_number(exp_pct, "#.#") + "%"

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Cached Variables (Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ÙƒØ§Ø´)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var float cached_atr_ratio = na
var float cached_vwap_dist = na
var string cached_stock_profile = ""
var color cached_profile_color = na
var int cached_setup_quality = 0
var string cached_trade_grade = ""
var color cached_grade_color = na
var int cached_confluence = 0
var float cached_probability = 50.0
var float cached_sortino = na
var float cached_calmar = na
var float cached_avg_r = na
var string cached_recent_summary = ""
var string cached_market_temp = ""
var color cached_temp_color = na

// Forward declarations (Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©)
var float nearest_support = na
var float nearest_resistance = na
var float support_effective_strength = na
var float resistance_effective_strength = na

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø¡ 3/7
// ØªÙ… Ø¥Ø¶Ø§ÙØ©:
// âœ… Ø¬Ù„Ø³Ø§Øª EGX (Pre-Open, Opening, Regular, Closing)
// âœ… ÙÙ„Ø§ØªØ± Ø§Ù„ÙˆÙ‚Øª (ØªØ¬Ù†Ø¨ Ø£ÙˆÙ„/Ø¢Ø®Ø± N Ø¯Ù‚ÙŠÙ‚Ø©)
// âœ… MTF Analysis (6 Ø£Ø·Ø± Ø²Ù…Ù†ÙŠØ©)
// âœ… Market Regime Detection (5 Ø£Ù†Ø¸Ù…Ø©)
// âœ… Stock Profile Classifier
// âœ… Visual Helpers (10+ Ø¯Ø§Ù„Ø©)
// âœ… Cached Variables
// 
// ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±ÙˆØ· (Build-Blockers Safe âœ“)
// 
// Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ø¬Ø²Ø¡ 4/7 (Ø§Ù„Ø£Ù†Ù…Ø§Ø· + S/R + ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ + Ø§Ù„ØªÙ‚ÙŠÙŠÙ…)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¬Ø²Ø¡ 4/7: Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ù…ÙˆØ¹ + Ø§Ù„Ø¯Ø¹Ù…/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© + ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ + Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
// v14.0 - Build-Blockers Safe âœ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ù…ÙˆØ¹ (Candlestick Patterns)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_PATTERNS = txt("ðŸ•¯ï¸ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø´Ù…ÙˆØ¹", "ðŸ•¯ï¸ Candle Patterns")
use_patterns = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø·","Enable Pattern Detection"), 
     group=G_PATTERNS)
require_volume_for_patterns = input.bool(true, txt("Ø§Ø´ØªØ±Ø§Ø· Ø­Ø¬Ù… Ù‚ÙˆÙŠ","Require Strong Volume"), 
     group=G_PATTERNS)
min_candle_size_atr = input.float(0.5, txt("Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ø´Ù…Ø¹Ø© (xATR)","Min Candle Size (xATR)"), 
     step=0.1, 
     minval=0.2, 
     maxval=2.0, 
     group=G_PATTERNS)

float body = c - o
float body_size = math.abs(body)
float candle_range_pat = h - l
float upper_wick = h - math.max(c, o)
float lower_wick = math.min(c, o) - l

float body_prev = nz(c[1] - o[1], 0.0)
float body_size_prev = math.abs(body_prev)

bool candle_big_enough = candle_range_pat > atr_safe * min_candle_size_atr
bool candle_not_doji   = body_size > syminfo.mintick * 5.0
bool volume_condition  = not require_volume_for_patterns or (v > v_sma20 * 1.5)

bool bullish_engulfing = use_patterns and volume_condition and body > 0 and body_prev < 0 and c >= nz(o[1]) and o <= nz(c[1]) and body_size > body_size_prev * 1.2 and candle_big_enough
bool bearish_engulfing = use_patterns and volume_condition and body < 0 and body_prev > 0 and c <= nz(o[1]) and o >= nz(c[1]) and body_size > body_size_prev * 1.2 and candle_big_enough
bool hammer            = use_patterns and candle_big_enough and lower_wick > body_size * 2.0 and upper_wick < body_size * 0.3 and candle_not_doji and (not require_volume_for_patterns or v > v_sma20)
bool shooting_star     = use_patterns and candle_big_enough and upper_wick > body_size * 2.0 and lower_wick < body_size * 0.3 and candle_not_doji and (not require_volume_for_patterns or v > v_sma20)
bool doji              = use_patterns and body_size < candle_range_pat * 0.1 and candle_range_pat > atr_safe * 0.3
bool bullish_pin       = use_patterns and volume_condition and lower_wick > candle_range_pat * 0.6 and upper_wick < candle_range_pat * 0.2 and c > o and candle_big_enough
bool bearish_pin       = use_patterns and volume_condition and upper_wick > candle_range_pat * 0.6 and lower_wick < candle_range_pat * 0.2 and c < o and candle_big_enough

bool morning_star = false
if use_patterns and volume_condition and bar_index >= 2
    morning_star := nz(c[2]) < nz(o[2]) and body_size_prev < nz(math.abs(c[2] - o[2]), 1.0) * 0.3 and c > o and c > (nz(o[2]) + nz(c[2])) / 2.0 and candle_big_enough

bool evening_star = false
if use_patterns and volume_condition and bar_index >= 2
    evening_star := nz(c[2]) > nz(o[2]) and body_size_prev < nz(math.abs(c[2] - o[2]), 1.0) * 0.3 and c < o and c < (nz(o[2]) + nz(c[2])) / 2.0 and candle_big_enough

bool three_white_soldiers = false
if use_patterns and bar_index >= 2
    three_white_soldiers := c > o and nz(c[1]) > nz(o[1]) and nz(c[2]) > nz(o[2]) and c > nz(c[1]) and nz(c[1]) > nz(c[2]) and body_size > atr_safe * 0.4 and v > v_sma20

bool three_black_crows = false
if use_patterns and bar_index >= 2
    three_black_crows := c < o and nz(c[1]) < nz(o[1]) and nz(c[2]) < nz(o[2]) and c < nz(c[1]) and nz(c[1]) < nz(c[2]) and body_size > atr_safe * 0.4 and v > v_sma20

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„ÙØ¬ÙˆØ§Øª (Gaps)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_GAPS = txt("âš¡ Ø§Ù„ÙØ¬ÙˆØ§Øª", "âš¡ Gaps")
enable_gaps         = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ ÙƒØ´Ù Ø§Ù„ÙØ¬ÙˆØ§Øª","Enable Gap Detection"), 
     group=G_GAPS)
gap_up_threshold    = input.float(2.0, txt("Ø­Ø¯ Ø§Ù„ÙØ¬ÙˆØ© Ø§Ù„ØµØ§Ø¹Ø¯Ø© %","Gap Up Threshold %"), 
     step=0.1, 
     minval=0.5, 
     maxval=10.0, 
     group=G_GAPS)
gap_down_threshold  = input.float(2.0, txt("Ø­Ø¯ Ø§Ù„ÙØ¬ÙˆØ© Ø§Ù„Ù‡Ø§Ø¨Ø·Ø© %","Gap Down Threshold %"), 
     step=0.1, 
     minval=0.5, 
     maxval=10.0, 
     group=G_GAPS)
ignore_auction_gaps = input.bool(true, txt("ØªØ¬Ø§Ù‡Ù„ ÙØ¬ÙˆØ§Øª Ø§Ù„Ù…Ø²Ø§Ø¯Ø§Øª","Ignore Auction Gaps"), 
     group=G_GAPS)
gaps_require_volume = input.bool(true, txt("Ø§Ø´ØªØ±Ø§Ø· Ø­Ø¬Ù… Ù‚ÙˆÙŠ","Require Volume"), 
     group=G_GAPS)

bool gap_up_detected   = enable_gaps and bar_index >= 1 and o > nz(c[1]) * (1.0 + gap_up_threshold / 100.0)   and (not ignore_auction_gaps or not in_auction) and (not gaps_require_volume or v > v_sma20 * 1.5)
bool gap_down_detected = enable_gaps and bar_index >= 1 and o < nz(c[1]) * (1.0 - gap_down_threshold / 100.0) and (not ignore_auction_gaps or not in_auction) and (not gaps_require_volume or v > v_sma20 * 1.5)

var float last_gap_up_level   = na
var float last_gap_down_level = na
if gap_up_detected
    last_gap_up_level := nz(c[1])
if gap_down_detected
    last_gap_down_level := nz(c[1])

bool gap_up_filled   = not na(last_gap_up_level) and l <= last_gap_up_level
bool gap_down_filled = not na(last_gap_down_level) and h >= last_gap_down_level
if gap_up_filled
    last_gap_up_level := na
if gap_down_filled
    last_gap_down_level := na

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø±Ø³Ù… (Chart Patterns)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_CHART = txt("ðŸ“ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø±Ø³Ù…", "ðŸ“ Chart Patterns")
use_chart_patterns   = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø±Ø³Ù…","Enable Chart Patterns"), 
     group=G_CHART)
pattern_lookback     = input.int(10, txt("Ù†Ø·Ø§Ù‚ Ø§Ù„ÙƒØ´Ù","Detection Lookback"), 
     minval=5, 
     maxval=50, 
     group=G_CHART)
pivot_length         = input.int(7,  txt("Ø·ÙˆÙ„ Pivot","Pivot Length"), 
     minval=3, 
     maxval=15, 
     group=G_CHART)
double_tolerance_pct = input.float(1.5, txt("Ø³Ù…Ø§Ø­ÙŠØ© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ %","Double Tolerance %"), 
     step=0.1, 
     minval=0.5, 
     maxval=5.0, 
     group=G_CHART)

// âœ… FIX: Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
float highest_range = ta.highest(h, pattern_lookback)
float lowest_range  = ta.lowest(l, pattern_lookback)
bool _breakout_cross  = ta.crossover(c, nz(highest_range[1]))
bool _breakdown_cross = ta.crossunder(c, nz(lowest_range[1]))
bool breakout_resistance = use_chart_patterns ? _breakout_cross : false
bool breakdown_support   = use_chart_patterns ? _breakdown_cross : false

float pivot_high_val = ta.pivothigh(h, pivot_length, pivot_length)
float pivot_low_val  = ta.pivotlow(l,  pivot_length, pivot_length)

var float last_pivot_high = na
var float prev_pivot_high = na
var float last_pivot_low  = na
var float prev_pivot_low  = na

if not na(pivot_high_val)
    prev_pivot_high := last_pivot_high
    last_pivot_high := pivot_high_val
if not na(pivot_low_val)
    prev_pivot_low := last_pivot_low
    last_pivot_low := pivot_low_val

bool double_top = false
if use_chart_patterns and not na(pivot_high_val) and not na(prev_pivot_high)
    float tol_dt = double_tolerance_pct / 100.0
    double_top := math.abs(pivot_high_val - prev_pivot_high) / math.max(pivot_high_val, 0.01) < tol_dt and v > v_sma20

bool double_bottom = false
if use_chart_patterns and not na(pivot_low_val) and not na(prev_pivot_low)
    float tol_db = double_tolerance_pct / 100.0
    double_bottom := math.abs(pivot_low_val - prev_pivot_low) / math.max(pivot_low_val, 0.01) < tol_db and v > v_sma20

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ø¯Ø¹Ù…/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Dynamic Support/Resistance)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_SR = txt("ðŸŽ¯ Ø§Ù„Ø¯Ø¹Ù…/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©", "ðŸŽ¯ Support/Resistance")
use_sr               = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ S/R Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ","Enable Dynamic S/R"), 
     group=G_SR)
sr_pivot_length      = input.int(10, txt("Ø·ÙˆÙ„ Pivot","Pivot Length"), 
     minval=5, 
     maxval=20, 
     group=G_SR)
max_sr_levels        = input.int(3, txt("Ø£Ù‚ØµÙ‰ Ù…Ø³ØªÙˆÙŠØ§Øª Ù„ÙƒÙ„ Ø¬Ù‡Ø©","Max Levels per Side"), 
     minval=2, 
     maxval=5, 
     group=G_SR)
sr_merge_tolerance   = input.float(0.5, txt("Ø³Ù…Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬ %","Merge Tolerance %"), 
     step=0.1, 
     minval=0.1, 
     maxval=2.0, 
     group=G_SR)
sr_touch_tolerance   = input.float(0.3, txt("Ø³Ù…Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ù…Ø³Ø© %","Touch Tolerance %"), 
     step=0.05, 
     minval=0.0, 
     maxval=1.5, 
     group=G_SR)
sr_break_confirmation= input.float(0.5, txt("ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒØ³Ø± %","Break Confirmation %"), 
     step=0.1, 
     minval=0.0, 
     maxval=3.0, 
     group=G_SR)
use_daily_sr         = input.bool(true, txt("Ù…Ø³ØªÙˆÙŠØ§Øª ÙŠÙˆÙ…ÙŠØ©","Daily Levels"), 
     group=G_SR)
use_weekly_sr        = input.bool(true, txt("Ù…Ø³ØªÙˆÙŠØ§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©","Weekly Levels"), 
     group=G_SR)

float sr_pivot_high = ta.pivothigh(h, sr_pivot_length, sr_pivot_length)
float sr_pivot_low  = ta.pivotlow(l,  sr_pivot_length, sr_pivot_length)

var float[] sup_prices   = array.new_float()
var int[]   sup_strength = array.new_int()
var int[]   sup_touch    = array.new_int()

var float[] res_prices   = array.new_float()
var int[]   res_strength = array.new_int()
var int[]   res_touch    = array.new_int()

find_similar_level(float[] prices, float new_price, float tolerance_pct) =>
    int idx = -1
    if array.size(prices) > 0 and new_price > 0
        for ii = 0 to array.size(prices) - 1
            float existing = array.get(prices, ii)
            if math.abs(new_price - existing) / math.max(new_price, 0.01) <= (tolerance_pct / 100.0)
                idx := ii
                break
    idx

// âœ… FIX: Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù€ Arrays
if use_sr and not na(sr_pivot_low)
    if array.size(sup_prices) >= MAX_SR_LEVELS
        int to_remove = int(MAX_SR_LEVELS * SR_CLEANUP_PCT / 100)
        for i = 0 to to_remove - 1
            array.shift(sup_prices)
            array.shift(sup_strength)
            array.shift(sup_touch)
    
    int si = find_similar_level(sup_prices, sr_pivot_low, sr_merge_tolerance)
    if si != -1
        array.set(sup_strength, si, array.get(sup_strength, si) + 1)
        array.set(sup_touch,    si, bar_index)
    else
        array.push(sup_prices, sr_pivot_low)
        array.push(sup_strength, 1)
        array.push(sup_touch, bar_index)

if use_sr and not na(sr_pivot_high)
    if array.size(res_prices) >= MAX_SR_LEVELS
        int to_remove = int(MAX_SR_LEVELS * SR_CLEANUP_PCT / 100)
        for i = 0 to to_remove - 1
            array.shift(res_prices)
            array.shift(res_strength)
            array.shift(res_touch)
    
    int ri = find_similar_level(res_prices, sr_pivot_high, sr_merge_tolerance)
    if ri != -1
        array.set(res_strength, ri, array.get(res_strength, ri) + 1)
        array.set(res_touch,    ri, bar_index)
    else
        array.push(res_prices, sr_pivot_high)
        array.push(res_strength, 1)
        array.push(res_touch, bar_index)

float daily_high  = use_daily_sr  ? sec(syminfo.tickerid, "D", high)[1] : na
float daily_low   = use_daily_sr  ? sec(syminfo.tickerid, "D", low )[1] : na
float weekly_high = use_weekly_sr ? sec(syminfo.tickerid, "W", high)[1] : na
float weekly_low  = use_weekly_sr ? sec(syminfo.tickerid, "W", low )[1] : na

calc_effective_strength(int base_strength, int last_touch_bar) =>
    float age = math.max(0, bar_index - last_touch_bar)
    float half_life = 120.0
    float decay = math.pow(0.5, age / half_life)
    base_strength * decay

// Ø­Ø³Ø§Ø¨ Ø£Ù‚Ø±Ø¨ Ø¯Ø¹Ù…/Ù…Ù‚Ø§ÙˆÙ…Ø©
nearest_support := na
nearest_resistance := na
support_effective_strength := na
resistance_effective_strength := na

if use_sr and array.size(sup_prices) > 0
    float closest_sup = na
    float best_s = 0.0
    for ii = 0 to array.size(sup_prices) - 1
        float price = array.get(sup_prices, ii)
        if price < c
            if na(closest_sup) or (c - price) < (c - closest_sup)
                closest_sup := price
                best_s := calc_effective_strength(array.get(sup_strength, ii), array.get(sup_touch, ii))
    if not na(daily_low) and daily_low < c and (na(closest_sup) or daily_low > closest_sup)
        closest_sup := daily_low
        best_s := 5.0
    if not na(weekly_low) and weekly_low < c and (na(closest_sup) or weekly_low > closest_sup)
        closest_sup := weekly_low
        best_s := 8.0
    nearest_support := closest_sup
    support_effective_strength := best_s

if use_sr and array.size(res_prices) > 0
    float closest_res = na
    float best_r = 0.0
    for ii = 0 to array.size(res_prices) - 1
        float price2 = array.get(res_prices, ii)
        if price2 > c
            if na(closest_res) or (price2 - c) < (closest_res - c)
                closest_res := price2
                best_r := calc_effective_strength(array.get(res_strength, ii), array.get(res_touch, ii))
    if not na(daily_high) and daily_high > c and (na(closest_res) or daily_high < closest_res)
        closest_res := daily_high
        best_r := 5.0
    if not na(weekly_high) and weekly_high > c and (na(closest_res) or weekly_high < closest_res)
        closest_res := weekly_high
        best_r := 8.0
    nearest_resistance := closest_res
    resistance_effective_strength := best_r

bool touching_support    = not na(nearest_support)    and l <= nearest_support * (1.0 + sr_touch_tolerance / 100.0) and c >= nearest_support
bool touching_resistance = not na(nearest_resistance) and h >= nearest_resistance * (1.0 - sr_touch_tolerance / 100.0) and c <= nearest_resistance
bool support_broken      = not na(nearest_support)    and c < nearest_support  * (1.0 - sr_break_confirmation / 100.0) and v > v_sma20 * 1.5
bool resistance_broken   = not na(nearest_resistance) and c > nearest_resistance* (1.0 + sr_break_confirmation / 100.0) and v > v_sma20 * 1.5

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ (Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_FIB = txt("ðŸ“ ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ", "ðŸ“ Fibonacci")
use_fib           = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ","Enable Fibonacci"), 
     group=G_FIB)
fib_lookback      = input.int(50, txt("Ø·ÙˆÙ„ Ø§Ù„Ù†Ø·Ø§Ù‚","Lookback Period"), 
     minval=20, 
     maxval=200, 
     group=G_FIB)
show_golden_zone  = input.bool(false, txt("Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©","Show Golden Zone Box"), 
     group=G_FIB)
golden_zone_extend= input.int(20, txt("Ø§Ù…ØªØ¯Ø§Ø¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚","Box Extension"), 
     minval=5, 
     maxval=100, 
     group=G_FIB)

float fib_high  = ta.highest(h, fib_lookback)
float fib_low   = ta.lowest(l, fib_lookback)
float fib_range = fib_high - fib_low
float fib_382   = fib_low + fib_range * 0.382
float fib_618   = fib_low + fib_range * 0.618

float golden_zone_low  = math.min(fib_382, fib_618)
float golden_zone_high = math.max(fib_382, fib_618)
bool  in_golden_zone   = use_fib and c >= golden_zone_low and c <= golden_zone_high

var box golden_zone_box = na
if barstate.islast and use_fib and show_golden_zone
    if not na(golden_zone_box)
        box.delete(golden_zone_box)
    int left_bar  = bar_index - fib_lookback
    int right_bar = bar_index + golden_zone_extend
    golden_zone_box := box.new(left=left_bar, top=golden_zone_high, right=right_bar, bottom=golden_zone_low, bgcolor=color.new(color.rgb(255, 215, 0), 90), border_color=color.new(color.rgb(255, 215, 0), 50), border_width=1, xloc=xloc.bar_index)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø­Ø³Ø§Ø¨ Ø£Ù‚ØµÙ‰ Ø§Ù†Ø®ÙØ§Ø¶ Ù…ØªÙˆÙ‚Ø¹ (Max Drop Expected)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

calc_max_drop() =>
    float max_drop = na
    if not na(nearest_support)
        max_drop := nearest_support - (atr_safe * 2.0)
    max_drop

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Scoring System)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_SCORE = txt("âš–ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…", "âš–ï¸ Scoring System")
string G_WEIGHT = txt("âš–ï¸ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ø§Ù„Ø£ÙˆØ²Ø§Ù†", "âš–ï¸ Weight Profiles")

weight_profile = input.string("Ø§ÙØªØ±Ø§Ø¶ÙŠ", txt("Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø£ÙˆØ²Ø§Ù†","Weight Profile"), 
     options=["Ø§ÙØªØ±Ø§Ø¶ÙŠ","Ù„Ø­Ø¸ÙŠ","ÙŠÙˆÙ…ÙŠ","Ø£Ø³Ø¨ÙˆØ¹ÙŠ"], 
     group=G_WEIGHT)

float mult_trend    = 1.0
float mult_momentum = 1.0
float mult_volume   = 1.0
float mult_pattern  = 1.0
float mult_sr       = 1.0

if weight_profile == "Ù„Ø­Ø¸ÙŠ"
    mult_trend    := 1.10
    mult_momentum := 1.25
    mult_volume   := 1.30
    mult_pattern  := 0.70
    mult_sr       := 0.85
else if weight_profile == "ÙŠÙˆÙ…ÙŠ"
    mult_trend    := 1.00
    mult_momentum := 0.90
    mult_volume   := 0.85
    mult_pattern  := 1.20
    mult_sr       := 1.20
else if weight_profile == "Ø£Ø³Ø¨ÙˆØ¹ÙŠ"
    mult_trend    := 1.30
    mult_momentum := 0.70
    mult_volume   := 0.60
    mult_pattern  := 0.90
    mult_sr       := 1.40

w_trend_base    = input.float(1.2, txt("ÙˆØ²Ù† Ø§Ù„Ø§ØªØ¬Ø§Ù‡","Trend Weight"),    step=0.1, minval=0.0, maxval=3.0, group=G_SCORE)
w_momentum_base = input.float(1.0, txt("ÙˆØ²Ù† Ø§Ù„Ø²Ø®Ù…","Momentum Weight"),   step=0.1, minval=0.0, maxval=3.0, group=G_SCORE)
w_volume_base   = input.float(1.2, txt("ÙˆØ²Ù† Ø§Ù„Ø­Ø¬Ù…","Volume Weight"),     step=0.1, minval=0.0, maxval=3.0, group=G_SCORE)
w_pattern_base  = input.float(0.8, txt("ÙˆØ²Ù† Ø§Ù„Ø£Ù†Ù…Ø§Ø·","Pattern Weight"), step=0.1, minval=0.0, maxval=3.0, group=G_SCORE)
w_sr_base       = input.float(1.2, txt("ÙˆØ²Ù† Ø¯/Ù…","S/R Weight"),          step=0.1, minval=0.0, maxval=3.0, group=G_SCORE)
w_rs_base       = input.float(0.8, txt("ÙˆØ²Ù† RS","RS Weight"),            step=0.1, minval=0.0, maxval=3.0, group=G_SCORE)
w_macd_base     = input.float(0.4, txt("ÙˆØ²Ù† MACD","MACD Weight"),        step=0.1, minval=0.0, maxval=3.0, group=G_SCORE)
w_mtf_base      = input.float(1.2, txt("ÙˆØ²Ù† MTF","MTF Weight"),          step=0.1, minval=0.0, maxval=3.0, group=G_SCORE)

float w_trend    = w_trend_base    * mult_trend
float w_momentum = w_momentum_base * mult_momentum
float w_volume   = w_volume_base   * mult_volume
float w_pattern  = w_pattern_base  * mult_pattern
float w_sr       = w_sr_base       * mult_sr
float w_rs       = w_rs_base
float w_macd     = w_macd_base
float w_mtf      = w_mtf_base

calc_trend_score() =>
    float sc = 0.0
    if ema_bull_aligned
        sc += price_above_all_ema ? TREND_EMA_BULL_ABOVE : TREND_EMA_BULL
    else if ema_bear_aligned
        sc += price_below_all_ema ? TREND_EMA_BEAR_BELOW : TREND_EMA_BEAR
    if golden_cross
        sc += TREND_GOLDEN_CROSS
    else if death_cross
        sc += TREND_DEATH_CROSS
    if vwap_active
        if above_vwap and streak_above_vwap >= 3
            sc += TREND_VWAP_ABOVE_STREAK
        else if above_vwap
            sc += TREND_VWAP_ABOVE
        else if below_vwap and streak_below_vwap >= 3
            sc += TREND_VWAP_BELOW_STREAK
        else if below_vwap
            sc += TREND_VWAP_BELOW
    math.max(-40.0, math.min(40.0, sc)) * w_trend

calc_momentum_score() =>
    float sc = 0.0
    if rsi_bullish_zone and not rsi_overbought
        sc += MOM_RSI_BULL_ZONE
    else if rsi_bearish_zone and not rsi_oversold
        sc += MOM_RSI_BEAR_ZONE
    else if rsi_oversold and di_plus > di_minus
        sc += MOM_RSI_OVERSOLD
    else if rsi_overbought and di_minus > di_plus
        sc += MOM_RSI_OVERBOUGHT
    if adx_very_strong and di_plus > di_minus
        sc += MOM_ADX_VERY_STRONG_BULL
    else if adx_very_strong and di_minus > di_plus
        sc += MOM_ADX_VERY_STRONG_BEAR
    else if adx_strong and di_plus > di_minus
        sc += MOM_ADX_STRONG_BULL
    else if adx_strong and di_minus > di_plus
        sc += MOM_ADX_STRONG_BEAR
    else if adx_weak
        sc += MOM_ADX_WEAK
    if rsi_bullish_div
        sc += MOM_RSI_BULL_DIV
    if rsi_bearish_div
        sc += MOM_RSI_BEAR_DIV
    math.max(-35.0, math.min(35.0, sc)) * w_momentum

calc_volume_score() =>
    float sc = 0.0
    if vol_bullish and vol_extreme
        sc += VOL_BULL_EXTREME
    else if vol_bullish and vol_very_high
        sc += VOL_BULL_VHIGH
    else if vol_bullish
        sc += VOL_BULL
    if vol_bearish and vol_extreme
        sc += VOL_BEAR_EXTREME
    else if vol_bearish and vol_very_high
        sc += VOL_BEAR_VHIGH
    else if vol_bearish
        sc += VOL_BEAR
    if strong_buying_flow and v > vol_sma
        sc += VOL_BUYING_FLOW
    else if strong_selling_flow and v > vol_sma
        sc += VOL_SELLING_FLOW
    if net_pressure > 0 and v > vol_sma * 1.5
        sc += VOL_NET_PRESSURE_BULL
    else if net_pressure < 0 and v > vol_sma * 1.5
        sc += VOL_NET_PRESSURE_BEAR
    math.max(-30.0, math.min(30.0, sc)) * w_volume

calc_pattern_score() =>
    float sc = 0.0
    if bullish_engulfing or morning_star
        sc += 10.0
    if hammer or bullish_pin
        sc += 8.0
    if three_white_soldiers
        sc += 10.0
    if double_bottom
        sc += 10.0
    if bearish_engulfing or evening_star
        sc -= 10.0
    if shooting_star or bearish_pin
        sc -= 8.0
    if three_black_crows
        sc -= 10.0
    if double_top
        sc -= 10.0
    if breakout_resistance and v > v_sma20 * 1.5
        sc += 10.0
    else if breakdown_support and v > v_sma20 * 1.5
        sc -= 10.0
    if gap_up_detected
        sc += 6.0
    if gap_down_detected
        sc -= 6.0
    math.max(-20.0, math.min(20.0, sc)) * w_pattern

calc_sr_score() =>
    float sc = 0.0
    if not na(nearest_support)
        float dist_pct_s = safe_div((c - nearest_support), c, 0.0) * 100.0
        float strength_s = nz(support_effective_strength, 0.0)
        if dist_pct_s < 0.5 and strength_s >= 3.0
            sc += 15.0
        else if dist_pct_s < 1.0 and strength_s >= 2.0
            sc += 12.0
        else if dist_pct_s < 2.0
            sc += 8.0
    if not na(nearest_resistance)
        float dist_pct_r = safe_div((nearest_resistance - c), c, 0.0) * 100.0
        float strength_r = nz(resistance_effective_strength, 0.0)
        if dist_pct_r < 0.5 and strength_r >= 3.0
            sc -= 15.0
        else if dist_pct_r < 1.0 and strength_r >= 2.0
            sc -= 12.0
        else if dist_pct_r < 2.0
            sc -= 8.0
    if resistance_broken and v > v_sma20 * 2.0
        sc += 15.0
    else if support_broken and v > v_sma20 * 2.0
        sc -= 15.0
    if in_golden_zone and touching_support
        sc += 8.0
    math.max(-20.0, math.min(20.0, sc)) * w_sr

calc_rs_macd_score() =>
    float sc = 0.0
    if use_rs
        if rs_trend_bullish
            sc += 8.0
        else if rs_trend_bearish
            sc -= 8.0
    if use_macd
        if macd_bullish
            sc += 6.0
        else if macd_bearish
            sc -= 6.0
    (sc * w_rs) + (sc * w_macd * 0.5)

float trend_score    = calc_trend_score()
float momentum_score = calc_momentum_score()
float volume_score   = calc_volume_score()
float pattern_score  = calc_pattern_score()
float sr_score       = calc_sr_score()
float rs_macd_score  = calc_rs_macd_score()

float raw_score = trend_score + momentum_score + volume_score + pattern_score + sr_score + rs_macd_score

float mtf_adjustment = 0.0
if use_mtf
    if mtf_all_bullish
        mtf_adjustment := w_mtf * 15.0
    else if mtf_aligned_bullish
        mtf_adjustment := w_mtf * 10.0 * (mtf_bullish_count / 6.0)
    else if mtf_all_bearish
        mtf_adjustment := -w_mtf * 15.0
    else if mtf_aligned_bearish
        mtf_adjustment := -w_mtf * 10.0 * (mtf_bearish_count / 6.0)

float liquidity_penalty   = not liquidity_ok ? -12.0 : 0.0
float spread_penalty      = not spread_ok    ? -8.0  : 0.0
float golden_bonus        = in_golden_zone and touching_support ? 5.0 : 0.0
float correlation_penalty = correlation_weak ? -8.0  : 0.0

float final_score = math.max(-100.0, math.min(100.0, raw_score + mtf_adjustment + liquidity_penalty + spread_penalty + golden_bonus + correlation_penalty))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø¡ 4/7
// ØªÙ… Ø¥Ø¶Ø§ÙØ©:
// âœ… 9 Ø£Ù†Ù…Ø§Ø· Ø´Ù…ÙˆØ¹ (Engulfing, Hammer, Star, etc.)
// âœ… Ø§Ù„ÙØ¬ÙˆØ§Øª (Gaps) Ù…Ø¹ Ø§Ù„ØªØªØ¨Ø¹
// âœ… Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø±Ø³Ù… (Double Top/Bottom, Breakout)
// âœ… Ù†Ø¸Ø§Ù… S/R Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…ØªÙ‚Ø¯Ù… (Ù…Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù€ Arrays âœ“)
// âœ… ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ (Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©)
// âœ… Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒØ§Ù…Ù„ (8 Ù…ÙƒÙˆÙ†Ø§Øª)
// âœ… Ø­Ø³Ø§Ø¨ Ø£Ù‚ØµÙ‰ Ø§Ù†Ø®ÙØ§Ø¶ Ù…ØªÙˆÙ‚Ø¹
// 
// Build-Blockers Safe âœ“ | Arrays Limited âœ“
// 
// Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ø¬Ø²Ø¡ 5/7 (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø© + Ø§Ù„Ø¨Ø§Ùƒâ€‘ØªØ³Øª)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¬Ø²Ø¡ 5/7: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø© + Ø§Ù„Ø¨Ø§Ùƒâ€‘ØªØ³Øª Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†
// v14.0 - Build-Blockers Safe âœ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø© (Trade Management)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_TRADE = txt("âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø©", "âš™ï¸ Trade Management")

stop_type = input.string("Ù‡Ø¬ÙŠÙ† Ø°ÙƒÙŠ", txt("Ù†ÙˆØ¹ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©","Stop Loss Type"),
     options=["Ù‡ÙŠÙƒÙ„ÙŠ","ATR","Chandelier","Ù‡Ø¬ÙŠÙ†","Ù‡Ø¬ÙŠÙ† Ø°ÙƒÙŠ"], 
     group=G_TRADE)

structure_buffer    = input.float(0.5, txt("Ù‡Ø§Ù…Ø´ Ø£Ø³ÙÙ„/ÙÙˆÙ‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ %","Structure Buffer %"), 
     step=0.1, 
     minval=0.0, 
     maxval=2.0, 
     group=G_TRADE)
atr_stop_multiplier = input.float(2.2, txt("ATR: Ù…Ø¶Ø§Ø¹Ù Ø§Ù„ÙˆÙ‚Ù","ATR Stop Multiplier"), 
     step=0.1, 
     minval=0.5, 
     maxval=5.0, 
     group=G_TRADE)
chandelier_lookback = input.int(22, txt("Chandelier: Ù†Ø·Ø§Ù‚","Chandelier Lookback"), 
     minval=10, 
     maxval=100, 
     group=G_TRADE)
chandelier_atr_mult = input.float(3.0, txt("Chandelier: Ù…Ø¶Ø§Ø¹Ù ATR","Chandelier ATR Multiplier"), 
     step=0.1, 
     minval=1.0, 
     maxval=10.0, 
     group=G_TRADE)

target_method = input.string("ATR Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ", txt("Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ù‡Ø¯Ø§Ù","Targets Method"),
     options=["ATR","ATR Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ","Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©","ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ","Ù‡Ø¬ÙŠÙ†"], 
     group=G_TRADE)

atr_t1_mult = input.float(1.5, "T1 (xATR)", step=0.1, minval=0.5, maxval=10, group=G_TRADE)
atr_t2_mult = input.float(2.5, "T2 (xATR)", step=0.1, minval=1.0, maxval=15, group=G_TRADE)
atr_t3_mult = input.float(4.0, "T3 (xATR)", step=0.1, minval=2.0, maxval=25, group=G_TRADE)

pct_t1 = input.float(2.0, "T1 %", step=0.1, minval=0.5, maxval=15, group=G_TRADE)
pct_t2 = input.float(4.0, "T2 %", step=0.1, minval=1.0, maxval=25, group=G_TRADE)
pct_t3 = input.float(7.0, "T3 %", step=0.1, minval=2.0, maxval=40, group=G_TRADE)

use_trailing          = input.bool(true,  txt("ØªÙØ¹ÙŠÙ„ Trailing Stop","Enable Trailing Stop"), 
     group=G_TRADE)
trailing_activation   = input.string("T1", txt("ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯","Activate When"), 
     options=["ÙÙˆØ±ÙŠ","T1","T2"], 
     group=G_TRADE)
trailing_atr_mult     = input.float(2.0, txt("Trailing: Ù…Ø¶Ø§Ø¹Ù ATR","Trailing ATR Multiplier"), 
     step=0.1, 
     minval=0.5, 
     maxval=10.0, 
     group=G_TRADE)
trailing_tighten_only = input.bool(true,  txt("ØªØ¶ÙŠÙŠÙ‚ ÙÙ‚Ø· (Ù„Ø§ ØªÙˆØ³ÙŠØ¹)","Tighten Only"), 
     group=G_TRADE)

string G_PARTIAL   = txt("ðŸ“Š Ø®Ø±ÙˆØ¬ Ø¬Ø²Ø¦ÙŠ", "ðŸ“Š Partial Exit")
enable_partial_exit= input.bool(true, txt("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¬Ø²Ø¦ÙŠ","Enable Partial Exit"), 
     group=G_PARTIAL)
exit_pct_t1        = input.float(50.0, txt("Ø®Ø±ÙˆØ¬ % Ø¹Ù†Ø¯ T1","Exit % at T1"), 
     step=5, 
     minval=10, 
     maxval=80, 
     group=G_PARTIAL)
exit_pct_t2        = input.float(30.0, txt("Ø®Ø±ÙˆØ¬ % Ø¹Ù†Ø¯ T2","Exit % at T2"), 
     step=5, 
     minval=10, 
     maxval=60, 
     group=G_PARTIAL)
move_sl_after_t1   = input.bool(true, txt("Ø±ÙØ¹ SL Ø¥Ù„Ù‰ Entry Ø¹Ù†Ø¯ T1","Move SL to Entry at T1"), 
     group=G_PARTIAL)
move_sl_after_t2   = input.bool(true, txt("Ø±ÙØ¹ SL Ø¥Ù„Ù‰ T1 Ø¹Ù†Ø¯ T2","Move SL to T1 at T2"), 
     group=G_PARTIAL)

calc_stop_loss() =>
    float sl = na
    float buffer_frac = structure_buffer / 100.0
    float support_stop = not na(nearest_support) and nearest_support < c ? nearest_support * (1.0 - buffer_frac) : na
    float ema50_stop   = use_ema and ema_med < c ? ema_med * (1.0 - buffer_frac) : na
    float golden_stop  = in_golden_zone and not na(golden_zone_low) and golden_zone_low < c ? golden_zone_low * (1.0 - buffer_frac) : na

    float structural = na
    if not na(support_stop)
        structural := na(structural) ? support_stop : math.max(structural, support_stop)
    if not na(ema50_stop)
        structural := na(structural) ? ema50_stop : math.max(structural, ema50_stop)
    if not na(golden_stop)
        structural := na(structural) ? golden_stop : math.max(structural, golden_stop)

    float atr_stop = c - atr_safe * atr_stop_multiplier
    float chandelier_highest = ta.highest(h, chandelier_lookback)
    float chandelier_stop    = chandelier_highest - atr_safe * chandelier_atr_mult

    if stop_type == "Ù‡ÙŠÙƒÙ„ÙŠ"
        sl := structural
    else if stop_type == "ATR"
        sl := atr_stop
    else if stop_type == "Chandelier"
        sl := chandelier_stop
    else if stop_type == "Ù‡Ø¬ÙŠÙ†"
        sl := na(structural) ? atr_stop : structural
    else if stop_type == "Ù‡Ø¬ÙŠÙ† Ø°ÙƒÙŠ"
        if adx_val >= 25 and not na(structural)
            sl := structural
        else if adx_val < 20
            sl := chandelier_stop
        else
            sl := na(structural) ? atr_stop : math.max(structural, atr_stop)
    sl

float t1_calc = na
float t2_calc = na
float t3_calc = na

if target_method == "ATR"
    t1_calc := c + atr_safe * atr_t1_mult
    t2_calc := c + atr_safe * atr_t2_mult
    t3_calc := c + atr_safe * atr_t3_mult
else if target_method == "ATR Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ"
    float mult_factor = 1.0
    if adx_val >= 30
        mult_factor := 1.3
    else if adx_val < 20
        mult_factor := 0.7
    t1_calc := c + atr_safe * atr_t1_mult * mult_factor
    t2_calc := c + atr_safe * atr_t2_mult * mult_factor
    t3_calc := c + atr_safe * atr_t3_mult * mult_factor
else if target_method == "ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ"
    if not na(nearest_resistance)
        float dist_f = nearest_resistance - c
        t1_calc := c + dist_f * 0.382
        t2_calc := c + dist_f * 0.618
        t3_calc := nearest_resistance
    else
        t1_calc := c + atr_safe * atr_t1_mult
        t2_calc := c + atr_safe * atr_t2_mult
        t3_calc := c + atr_safe * atr_t3_mult
else if target_method == "Ù‡Ø¬ÙŠÙ†"
    if not na(nearest_resistance) and nearest_resistance > c * 1.02
        float dist_h = nearest_resistance - c
        t1_calc := c + dist_h * 0.382
        t2_calc := c + dist_h * 0.618
        t3_calc := nearest_resistance
    else
        t1_calc := c + atr_safe * atr_t1_mult
        t2_calc := c + atr_safe * atr_t2_mult
        t3_calc := c + atr_safe * atr_t3_mult
else
    t1_calc := c * (1 + pct_t1 / 100.0)
    t2_calc := c * (1 + pct_t2 / 100.0)
    t3_calc := c * (1 + pct_t3 / 100.0)

float base_sl = calc_stop_loss()

var float trailing_stop_level = na
var bool  trailing_is_active  = false

bool should_activate_trailing = false
if trailing_activation == "ÙÙˆØ±ÙŠ"
    should_activate_trailing := true
else if trailing_activation == "T1" and not na(t1_calc)
    if h >= t1_calc
        should_activate_trailing := true
else if trailing_activation == "T2" and not na(t2_calc)
    if h >= t2_calc
        should_activate_trailing := true

if use_trailing and should_activate_trailing and not trailing_is_active
    trailing_is_active := true

if trailing_is_active
    float new_trail = c - atr_safe * trailing_atr_mult
    if trailing_tighten_only
        trailing_stop_level := na(trailing_stop_level) ? new_trail : math.max(trailing_stop_level, new_trail)
    else
        trailing_stop_level := new_trail

float final_sl = na(base_sl) ? trailing_stop_level : (trailing_is_active and not na(trailing_stop_level) ? math.max(base_sl, trailing_stop_level) : base_sl)
bool  sl_valid = not na(final_sl) and final_sl < c

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø­Ø¬Ù… Ø§Ù„ØµÙÙ‚Ø© (Position Sizing)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_PS = txt("ðŸ’° Ø­Ø¬Ù… Ø§Ù„ØµÙÙ‚Ø©", "ðŸ’° Position Sizing")
enable_position_sizing = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨","Enable Calculation"), 
     group=G_PS)
account_capital        = input.float(100000, txt("Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (Ø¬.Ù…)","Capital (EGP)"), 
     step=1000, 
     minval=1000, 
     group=G_PS)
risk_per_trade_pct     = input.float(2.0, txt("Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ù„ÙƒÙ„ ØµÙÙ‚Ø© %","Risk per Trade %"), 
     step=0.1, 
     minval=0.5, 
     maxval=10.0, 
     group=G_PS)
ps_method              = input.string("Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ", txt("Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨","Calculation Method"), 
     options=["Fixed %","Kelly %","ATR-based","Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ"], 
     group=G_PS)
kelly_fraction         = input.float(0.25, "Kelly Fraction", 
     step=0.05, 
     minval=0.1, 
     maxval=1.0, 
     group=G_PS)
min_shares             = input.int(100, txt("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø£Ø³Ù‡Ù…","Min Shares"), 
     minval=10, 
     group=G_PS)
max_shares             = input.int(10000, txt("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø£Ø³Ù‡Ù…","Max Shares"), 
     step=100, 
     minval=100, 
     group=G_PS)
round_to_lot           = input.bool(true, txt("ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 100","Round to Lot 100"), 
     group=G_PS)

calc_position_size_dynamic(float entry, float sl_price) =>
    float shares = na
    if enable_position_sizing and not na(sl_price) and sl_price < entry and entry > 0
        float risk_per_share = entry - sl_price
        float account_risk   = account_capital * (risk_per_trade_pct / 100.0)

        if ps_method == "Fixed %"
            shares := safe_div(account_risk, risk_per_share, 0.0)
        else if ps_method == "Kelly %"
            float kelly_risk = account_capital * kelly_fraction * (risk_per_trade_pct / 100.0)
            shares := safe_div(kelly_risk, risk_per_share, 0.0)
        else if ps_method == "ATR-based"
            float atr_risk = atr_safe * 2.0
            shares := safe_div(account_risk, atr_risk, 0.0)
        else if ps_method == "Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ"
            float base_shares = safe_div(account_risk, risk_per_share, 0.0)

            float adx_multiplier = 1.0
            if adx_val > 35
                adx_multiplier := 0.7
            else if adx_val < 20
                adx_multiplier := 1.2

            float mtf_multiplier = 1.0
            if use_mtf
                if mtf_all_bullish
                    mtf_multiplier := 1.4
                else if mtf_aligned_bullish
                    mtf_multiplier := 1.0 + (mtf_bullish_count / 10.0)
                else if mtf_bearish_count >= 3
                    mtf_multiplier := 0.6

            float volatility_multiplier = 1.0
            if atr_ratio > 1.5
                volatility_multiplier := 0.75
            else if atr_ratio < 0.7
                volatility_multiplier := 1.1

            float score_multiplier = 1.0
            if final_score >= 75
                score_multiplier := 1.3
            else if final_score >= 60
                score_multiplier := 1.1
            else if final_score < 40
                score_multiplier := 0.7

            shares := base_shares * adx_multiplier * mtf_multiplier * volatility_multiplier * score_multiplier

        if round_to_lot
            shares := math.floor(shares / 100.0) * 100.0
        else
            shares := math.floor(shares)

        shares := math.max(min_shares, math.min(max_shares, shares))
    shares

string G_COST  = txt("ðŸ’¸ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ", "ðŸ’¸ Costs")
enable_costs   = input.bool(true, txt("Ø®ØµÙ… Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ù…Ù† R:R","Deduct Costs from R:R"), 
     group=G_COST)
commission_pct = input.float(0.2, txt("Ø¹Ù…ÙˆÙ„Ø© + Ø§Ù†Ø²Ù„Ø§Ù‚ %","Commission + Slippage %"), 
     step=0.01, 
     minval=0.0, 
     maxval=2.0, 
     group=G_COST)
float cost_factor = enable_costs ? (1.0 - commission_pct / 100.0) : 1.0

float entry_price = round_tick(c)
float sl_price    = round_tick(final_sl)
float t1_price    = round_tick(t1_calc * cost_factor)
float t2_price    = round_tick(t2_calc * cost_factor)
float t3_price    = round_tick(t3_calc * cost_factor)

float risk_amount_calc = (not na(sl_price) and sl_price < entry_price) ? (entry_price - sl_price) : na
float rr_t1 = (not na(risk_amount_calc) and risk_amount_calc > 0) ? safe_div((t1_price - entry_price), risk_amount_calc, 0.0) : na
float rr_t2 = (not na(risk_amount_calc) and risk_amount_calc > 0) ? safe_div((t2_price - entry_price), risk_amount_calc, 0.0) : na
float rr_t3 = (not na(risk_amount_calc) and risk_amount_calc > 0) ? safe_div((t3_price - entry_price), risk_amount_calc, 0.0) : na

string G_RR = txt("ðŸ“Š Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…/Ø¹", "ðŸ“Š R:R Requirements")
rr_threshold_expert   = input.float(2.5, txt("Ø­Ø¯ Ø§Ù„Ø®Ø¨ÙŠØ±","Expert Threshold"),    step=0.1, minval=1.0, maxval=5.0, group=G_RR)
rr_threshold_pro      = input.float(2.0, txt("Ø­Ø¯ Ø§Ù„Ù…Ø­ØªØ±Ù","Pro Threshold"),      step=0.1, minval=1.0, maxval=4.0, group=G_RR)
rr_threshold_standard = input.float(1.5, txt("Ø­Ø¯ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ","Standard Threshold"), step=0.1, minval=1.0, maxval=3.0, group=G_RR)
rr_threshold_beginner = input.float(1.2, txt("Ø­Ø¯ Ø§Ù„Ù…Ø¨ØªØ¯Ø¦","Beginner Threshold"), step=0.1, minval=0.5, maxval=2.0, group=G_RR)
rr_reference          = input.string("Ù…ØªÙˆØ³Ø·", txt("Ù…Ø±Ø¬Ø¹ Ù…/Ø¹","R:R Reference"), 
     options=["T1","T2","T3","Ù…ØªÙˆØ³Ø·"], 
     group=G_RR)

string G_SMART = txt("ðŸ§  Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø°ÙƒÙŠ", "ðŸ§  Smart Mode")
smart_mode   = input.string("Ù…Ø­ØªØ±Ù", txt("Ø§Ù„ÙˆØ¶Ø¹","Mode"), 
     options=["Ù…Ø¨ØªØ¯Ø¦","Ù‚ÙŠØ§Ø³ÙŠ","Ù…Ø­ØªØ±Ù","Ø®Ø¨ÙŠØ±"], 
     group=G_SMART)

bool is_beginner = smart_mode == "Ù…Ø¨ØªØ¯Ø¦"
bool is_standard = smart_mode == "Ù‚ÙŠØ§Ø³ÙŠ"
bool is_pro      = smart_mode == "Ù…Ø­ØªØ±Ù"
bool is_expert   = smart_mode == "Ø®Ø¨ÙŠØ±"

float rr_threshold = rr_threshold_standard
if is_expert
    rr_threshold := rr_threshold_expert
else if is_pro
    rr_threshold := rr_threshold_pro
else if is_beginner
    rr_threshold := rr_threshold_beginner

float rr_value = na
if rr_reference == "T1"
    rr_value := rr_t1
else if rr_reference == "T2"
    rr_value := rr_t2
else if rr_reference == "T3"
    rr_value := rr_t3
else
    rr_value := (rr_t1 + rr_t2) / 2.0

bool rr_acceptable = not na(rr_value) and rr_value >= rr_threshold

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„ØªØ±ÙŠØ¬Ø±Ø§Øª (Triggers)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_TRIGGER = txt("ðŸŽ¯ Ø§Ù„ØªØ±ÙŠØ¬Ø±Ø§Øª", "ðŸŽ¯ Triggers")
enable_advanced_triggers = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±ÙŠØ¬Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©","Enable Advanced Triggers"), 
     group=G_TRIGGER)

// âœ… FIX: ta.crossover Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
bool _vwap_cross_up    = ta.crossover(c, vwap_all)
bool _ema20_cross_up   = ta.crossover(c, ema_fast_all)

bool trigger_vwap_reclaim = enable_advanced_triggers and vwap_active and _vwap_cross_up and v > vol_sma
bool trigger_ema_bounce   = enable_advanced_triggers and _ema20_cross_up and rsi_val > 50 and v >= vol_sma
bool trigger_pivot_break  = enable_advanced_triggers and not na(last_pivot_high) and c > last_pivot_high and v > vol_sma

bool trigger_pattern_bullish  = bullish_engulfing or morning_star or hammer or bullish_pin or three_white_soldiers
bool trigger_support_bounce   = touching_support and (hammer or bullish_pin)
bool trigger_resistance_break = resistance_broken and v > v_sma20 * 2.0
bool trigger_golden_bounce    = in_golden_zone and trigger_support_bounce
bool trigger_macd = use_macd and macd_bullish and macd_histogram > 0

bool any_buy_trigger = trigger_vwap_reclaim or trigger_ema_bounce or trigger_pivot_break or trigger_pattern_bullish or trigger_support_bounce or trigger_resistance_break or trigger_golden_bounce or trigger_macd

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„ÙÙ„Ø§ØªØ± (Filters)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_FILTER = txt("ðŸ”’ Ø§Ù„ÙÙ„Ø§ØªØ±", "ðŸ”’ Filters")
use_strict_filters = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ ÙÙ„Ø§ØªØ± ØµØ§Ø±Ù…Ø©","Strict Filters"), 
     group=G_FILTER)

int  rsi_min_buy = is_beginner ? 45 : 40
bool filter_trend        = not use_strict_filters or ema_bull_aligned
bool filter_rsi          = rsi_val >= rsi_min_buy and rsi_val <= 75
bool filter_adx          = not use_strict_filters or adx_val >= adx_threshold
bool filter_volume       = not use_strict_filters or v > vol_sma * 1.2
bool filter_mtf          = not use_strict_filters or not (use_mtf and mtf_aligned_bearish)
bool filter_session_time = filter_session and filter_time_window
bool filter_liquidity    = liquidity_ok
bool filter_spread_ok    = spread_ok
bool filter_rs_ok        = not use_strict_filters or not (use_rs and rs_trend_bearish)
bool filter_regime_ok    = regime_allows_trade
bool filter_volatility   = volatility_filter_ok
bool filter_corr_ok      = not correlation_weak

bool all_filters_pass = filter_trend and filter_rsi and filter_adx and filter_volume and filter_mtf and filter_session_time and filter_liquidity and filter_spread_ok and filter_rs_ok and filter_sharia and filter_regime_ok and filter_volatility and filter_corr_ok

string G_COOLDOWN = txt("â° ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡", "â° Cooldown")
enable_cooldown = input.bool(true, txt("ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨Ø±ÙŠØ¯","Enable Cooldown"), 
     group=G_COOLDOWN)
cooldown_bars   = input.int(8, txt("ÙØªØ±Ø© Ø§Ù„ØªØ¨Ø±ÙŠØ¯ (Ø´Ù…ÙˆØ¹)","Cooldown Bars"), 
     minval=1, 
     maxval=100, 
     group=G_COOLDOWN)

var int last_exit_bar = na
bool cooldown_active = enable_cooldown and not na(last_exit_bar) and (bar_index - last_exit_bar < cooldown_bars)
bool cooldown_allows = not cooldown_active

// âœ… FIX: Ù…Ù†Ø¹ Ø§Ù„ØªÙ†Ø§Ù‚Ø¶Ø§Øª (Polarity Check)
float score_polarity = final_score >= 0 ? 1.0 : -1.0
float trend_polarity = ema_bull_aligned ? 1.0 : ema_bear_aligned ? -1.0 : 0.0
bool polarity_conflict = (score_polarity > 0 and trend_polarity < 0) or (score_polarity < 0 and trend_polarity > 0)

// Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
bool buy_signal_standard = (final_score >= 55) and all_filters_pass and any_buy_trigger and not polarity_conflict
bool confirmed_buy_signal = buy_signal_standard

bool quality_gate = liquidity_ok and spread_ok and bar_range_percent <= max_bar_range_pct
bool final_gates  = quality_gate and cooldown_allows and sl_valid and rr_acceptable and filter_session_time

bool FINAL_BUY = confirmed_buy_signal and final_gates

// âœ… FIX: ta.crossunder Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±Ø·
bool _ema50_cross_down = ta.crossunder(c, ema_med_all)
bool _vwap_cross_down  = ta.crossunder(c, vwap_all)

bool exit_ema50_cross    = _ema50_cross_down and adx_val >= adx_threshold
bool exit_support_break  = support_broken and v > v_sma20 * 2.0
bool exit_vwap_loss      = vwap_active and _vwap_cross_down and nz(streak_above_vwap[1], 0) >= 3 and v > vol_sma
bool exit_rsi_extreme    = rsi_val >= 80
bool exit_pattern_bearish= bearish_engulfing or evening_star or shooting_star or three_black_crows

bool confirmed_sell_signal = exit_ema50_cross or exit_support_break or exit_vwap_loss or exit_rsi_extreme or exit_pattern_bearish or polarity_conflict
bool FINAL_SELL = confirmed_sell_signal and filter_sharia

var float calculated_position_size  = na
var float calculated_position_value = na
var float calculated_risk_amount    = na
var int entry_bar = na

if barstate.isconfirmed and FINAL_BUY
    entry_bar := bar_index
    calculated_position_size  := calc_position_size_dynamic(c, final_sl)
    calculated_position_value := calculated_position_size * c
    calculated_risk_amount    := calculated_position_size * (c - final_sl)
    trailing_is_active := false
    trailing_stop_level := na

// âœ… FIX: reset trailing Ø¹Ù†Ø¯ exit
if barstate.isconfirmed and FINAL_SELL
    last_exit_bar := bar_index
    entry_bar := na
    trailing_is_active := false
    trailing_stop_level := na

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Backtesting Engine Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_BT = txt("ðŸ“Š Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠ", "ðŸ“Š Backtesting")
enable_backtesting  = input.bool(true,  txt("ØªÙØ¹ÙŠÙ„ Backtesting","Enable Backtesting"), 
     group=G_BT)
bt_use_partial_exit = input.bool(true,  txt("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¬Ø²Ø¦ÙŠ","Use Partial Exit"), 
     group=G_BT)
bt_use_trailing     = input.bool(true,  txt("Ø§Ø³ØªØ®Ø¯Ø§Ù… Trailing Stop","Use Trailing Stop"), 
     group=G_BT)
bt_slippage_pct     = input.float(0.10, txt("Ø§Ù†Ø²Ù„Ø§Ù‚ Ø¥Ø¶Ø§ÙÙŠ %","Extra Slippage %"), 
     step=0.05, 
     minval=0.0, 
     maxval=1.0, 
     group=G_BT)

// âœ… NEW: Dynamic Slippage
calc_dynamic_slippage() =>
    float base_slip = bt_slippage_pct
    float vol_ratio = safe_div(v, vol_sma, 1.0)
    
    if gap_up_detected or gap_down_detected
        base_slip *= 3.0
    
    if vol_ratio < 0.5
        base_slip *= 2.5
    else if vol_ratio < 0.75
        base_slip *= 1.5
    
    if atr_ratio > 1.5
        base_slip *= 1.8
    
    if in_opening or in_closing
        base_slip *= 1.3
    
    base_slip

var bool  bt_in_position      = false
var float bt_entry_price      = na
var float bt_stop_loss        = na
var int   bt_entry_bar        = na
var int   bt_bars_in_trade    = 0
var float bt_position_size    = na
var int   bt_exit_stage       = 0

var bool  bt_trailing_active  = false
var float bt_trailing_stop    = na

var float bt_shares_total         = na
var float bt_shares_remaining     = na
var float bt_realized_pnl         = 0.0
var float bt_entry_risk_per_share = na

var int   bt_total_trades   = 0
var int   bt_winning_trades = 0
var int   bt_losing_trades  = 0
var float bt_gross_profit   = 0.0
var float bt_gross_loss     = 0.0
var float bt_total_pnl      = 0.0
var float bt_max_win        = 0.0
var float bt_max_loss       = 0.0

var float bt_equity      = na
var float bt_peak_equity = na
var float bt_max_dd      = 0.0

if barstate.isfirst and enable_backtesting
    bt_equity      := account_capital
    bt_peak_equity := account_capital
    bt_max_dd      := 0.0

var string[] trade_types       = array.new_string()
var float[]  trade_pnls        = array.new_float()
var int[]    trade_bars_held   = array.new_int()
var float[]  trade_rr_achieved = array.new_float()

add_trade_to_history(string exit_type, float pnl, int bars_held, float rr) =>
    if array.size(trade_types) >= 10
        array.shift(trade_types)
        array.shift(trade_pnls)
        array.shift(trade_bars_held)
        array.shift(trade_rr_achieved)
    array.push(trade_types, exit_type)
    array.push(trade_pnls, pnl)
    array.push(trade_bars_held, bars_held)
    array.push(trade_rr_achieved, rr)

if enable_backtesting and barstate.isconfirmed
    if not bt_in_position and FINAL_BUY and sl_valid
        bt_in_position      := true
        bt_entry_price      := c
        bt_stop_loss        := final_sl
        bt_entry_bar        := bar_index
        bt_bars_in_trade    := 0
        bt_exit_stage       := 0
        bt_position_size    := calc_position_size_dynamic(c, final_sl)
        bt_total_trades     += 1
        bt_shares_total         := bt_position_size
        bt_shares_remaining     := bt_position_size
        bt_realized_pnl         := 0.0
        bt_entry_risk_per_share := bt_entry_price - bt_stop_loss
        bt_trailing_active      := false
        bt_trailing_stop        := na

    if bt_in_position
        bt_bars_in_trade += 1

        if bt_use_trailing
            bool bt_should_activate = false
            if trailing_activation == "ÙÙˆØ±ÙŠ"
                bt_should_activate := true
            else if trailing_activation == "T1" and not na(t1_price) and h >= t1_price
                bt_should_activate := true
            else if trailing_activation == "T2" and not na(t2_price) and h >= t2_price
                bt_should_activate := true

            if bt_should_activate and not bt_trailing_active
                bt_trailing_active := true

            if bt_trailing_active
                float bt_new_trail = c - atr_safe * trailing_atr_mult
                if na(bt_trailing_stop)
                    bt_trailing_stop := bt_new_trail
                else
                    bt_trailing_stop := trailing_tighten_only ? math.max(bt_trailing_stop, bt_new_trail) : bt_new_trail

        float current_sl = bt_stop_loss
        if bt_trailing_active and not na(bt_trailing_stop)
            current_sl := math.max(current_sl, bt_trailing_stop)

        bool hit_stop = l <= current_sl
        bool hit_exit_signal = FINAL_SELL
        bool hit_t1 = false
        bool hit_t2 = false
        bool hit_t3 = false

        if bt_use_partial_exit
            if bt_exit_stage == 0 and h >= t1_price
                hit_t1 := true
            else if bt_exit_stage == 1 and h >= t2_price
                hit_t2 := true
            else if bt_exit_stage == 2 and h >= t3_price
                hit_t3 := true
        else
            if h >= t1_price
                hit_t1 := true

        if hit_stop or hit_t1 or hit_t2 or hit_t3 or hit_exit_signal
            string exit_reason = ""
            float  exit_price  = na
            if hit_stop
                exit_reason := "SL"
                exit_price  := current_sl
            else if hit_t3
                exit_reason := "T3"
                exit_price  := t3_price
            else if hit_t2
                exit_reason := "T2"
                exit_price  := t2_price
            else if hit_t1
                exit_reason := "T1"
                exit_price  := t1_price
            else
                exit_reason := txt("Ø¥Ø´Ø§Ø±Ø©","Signal")
                exit_price  := c

            // âœ… NEW: Dynamic Slippage
            exit_price := exit_price * (1.0 - calc_dynamic_slippage() / 100.0)

            float shares_to_exit = 0.0
            if hit_stop or hit_exit_signal or hit_t3 or not bt_use_partial_exit
                shares_to_exit := bt_shares_remaining
            else if hit_t1
                shares_to_exit := bt_shares_remaining * (exit_pct_t1 / 100.0)
                bt_exit_stage  := 1
            else if hit_t2
                shares_to_exit := bt_shares_remaining * (exit_pct_t2 / 100.0)
                bt_exit_stage  := 2

            shares_to_exit := math.min(shares_to_exit, bt_shares_remaining)
            float pnl_this_exit = (exit_price - bt_entry_price) * shares_to_exit
            bt_realized_pnl     += pnl_this_exit
            bt_shares_remaining -= shares_to_exit

            bt_total_pnl += pnl_this_exit
            bt_equity    += pnl_this_exit
            if bt_equity > bt_peak_equity
                bt_peak_equity := bt_equity
            float curr_dd = safe_div((bt_peak_equity - bt_equity), bt_peak_equity, 0.0) * 100.0
            bt_max_dd := math.max(bt_max_dd, curr_dd)

            if bt_use_partial_exit
                if move_sl_after_t1 and hit_t1
                    bt_stop_loss := math.max(bt_stop_loss, bt_entry_price)
                else if move_sl_after_t2 and hit_t2
                    bt_stop_loss := math.max(bt_stop_loss, t1_price)

            bool final_close = bt_shares_remaining <= 0.0 or hit_stop or hit_exit_signal or (bt_use_partial_exit and bt_exit_stage >= 2 and hit_t3)
            if final_close
                float rr_achieved = na
                if not na(bt_entry_risk_per_share) and bt_entry_risk_per_share > 0 and not na(bt_shares_total) and bt_shares_total > 0
                    rr_achieved := bt_realized_pnl / (bt_shares_total * bt_entry_risk_per_share)

                add_trade_to_history(exit_reason, bt_realized_pnl, bt_bars_in_trade, rr_achieved)

                if bt_realized_pnl > 0
                    bt_winning_trades += 1
                    bt_gross_profit   += bt_realized_pnl
                    bt_max_win        := math.max(bt_max_win, bt_realized_pnl)
                else
                    bt_losing_trades  += 1
                    bt_gross_loss     += math.abs(bt_realized_pnl)
                    bt_max_loss       := math.min(bt_max_loss, bt_realized_pnl)

                bt_in_position      := false
                bt_entry_price      := na
                bt_stop_loss        := na
                bt_entry_bar        := na
                bt_bars_in_trade    := 0
                bt_exit_stage       := 0
                bt_trailing_active  := false
                bt_trailing_stop    := na
                last_exit_bar       := bar_index

float bt_win_rate      = bt_total_trades > 0 ? safe_div(bt_winning_trades * 100.0, bt_total_trades, 0.0) : 0.0
float bt_avg_win       = bt_winning_trades > 0 ? safe_div(bt_gross_profit, bt_winning_trades, 0.0) : 0.0
float bt_avg_loss      = bt_losing_trades  > 0 ? safe_div(bt_gross_loss,  bt_losing_trades,  0.0) : 0.0
float bt_profit_factor = bt_gross_loss > 0 ? safe_div(bt_gross_profit, bt_gross_loss, 0.0) : na
float bt_expectancy    = bt_total_trades > 0 ? safe_div(bt_total_pnl, bt_total_trades, 0.0) : 0.0
float bt_roi           = safe_div((bt_equity - account_capital), account_capital, 0.0) * 100.0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø¡ 5/7
// ØªÙ… Ø¥Ø¶Ø§ÙØ©:
// âœ… Ø¥Ø¯Ø§Ø±Ø© ØµÙÙ‚Ø© Ù…ØªÙ‚Ø¯Ù…Ø© (5 Ø£Ù†ÙˆØ§Ø¹ SL + Trailing + 5 Ø·Ø±Ù‚ Targets)
// âœ… Position Sizing Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (4 Ø·Ø±Ù‚)
// âœ… 8+ ØªØ±ÙŠØ¬Ø± Ù…ØªÙ‚Ø¯Ù…
// âœ… 12+ ÙÙ„ØªØ± Ø°ÙƒÙŠ
// âœ… Polarity Check (Ù…Ù†Ø¹ Ø§Ù„ØªÙ†Ø§Ù‚Ø¶Ø§Øª) âœ“
// âœ… Backtesting Engine Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹:
//    - Partial Exit Ø­Ù‚ÙŠÙ‚ÙŠ
//    - Trailing Stop
//    - Dynamic Slippage âœ“ (Ø¬Ø¯ÙŠØ¯)
// âœ… Reset Trailing Ø¹Ù†Ø¯ Exit âœ“
// 
// Build-Blockers Safe âœ“ | No Repainting âœ“
// 
// Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ø¬Ø²Ø¡ 6/7 (Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø£Ø¯Ø§Ø¡ + Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¬Ø²Ø¡ 6/7: Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© + Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª
// v14.0 - Build-Blockers Safe âœ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Performance Metrics Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

float bt_avg_bars_held = 0.0
if bt_total_trades > 0 and array.size(trade_bars_held) > 0
    float sum_b = 0.0
    for i = 0 to array.size(trade_bars_held) - 1
        sum_b += array.get(trade_bars_held, i)
    bt_avg_bars_held := safe_div(sum_b, array.size(trade_bars_held), 0.0)

// Ù†Ø³Ø¨Ø© Ø´Ø§Ø±Ø¨ (Sharpe Ratio)
calc_sharpe() =>
    float sharpe = na
    if array.size(trade_pnls) >= 5
        float s  = 0.0
        float s2 = 0.0
        int   n  = array.size(trade_pnls)
        for i = 0 to n - 1
            float p = array.get(trade_pnls, i)
            s  += p
            s2 += p * p
        float mean_ret   = s / n
        float variance_r = (s2 / n) - (mean_ret * mean_ret)
        float sd_ret     = math.sqrt(math.max(variance_r, 0.0))
        if sd_ret > 0
            sharpe := mean_ret / sd_ret
    sharpe

float bt_sharpe = calc_sharpe()

// Ù†Ø³Ø¨Ø© Ø³ÙˆØ±ØªÙŠÙ†Ùˆ (Sortino Ratio)
calc_sortino() =>
    float sortino = na
    if array.size(trade_pnls) >= 5
        float sum_pnl = 0.0
        float downside_sum = 0.0
        int down_count = 0
        for i = 0 to array.size(trade_pnls) - 1
            float p = array.get(trade_pnls, i)
            sum_pnl += p
            if p < 0
                downside_sum += p * p
                down_count += 1
        if down_count > 0
            float mean_ret = sum_pnl / array.size(trade_pnls)
            float downside_dev = math.sqrt(downside_sum / down_count)
            sortino := downside_dev > 0 ? mean_ret / downside_dev : na
    sortino

float bt_sortino = calc_sortino()

// Ù†Ø³Ø¨Ø© ÙƒØ§Ù„Ù…Ø§Ø± (Calmar Ratio)
float bt_calmar = bt_max_dd > 0 ? safe_div(bt_roi, bt_max_dd, 0.0) : na

// Recovery Factor
float bt_recovery_factor = bt_max_dd > 0 ? safe_div(bt_total_pnl, bt_max_dd, 0.0) : na

// T-Hit Rate
int t_hits = 0
if array.size(trade_types) > 0
    for i = 0 to array.size(trade_types) - 1
        string tt = array.get(trade_types, i)
        if str.contains(tt, "T")
            t_hits += 1
float bt_t_hit_rate = array.size(trade_types) > 0 ? safe_div(t_hits * 100.0, array.size(trade_types), 0.0) : 0.0

// Win/Lose Streaks
int current_losing_streak = 0
int max_losing_streak = 0
if array.size(trade_pnls) > 0
    for i = array.size(trade_pnls) - 1 to 0
        if array.get(trade_pnls, i) < 0
            current_losing_streak += 1
            if current_losing_streak > max_losing_streak
                max_losing_streak := current_losing_streak
        else
            current_losing_streak := 0

int current_win_streak = 0
int max_win_streak = 0
if array.size(trade_pnls) > 0
    for i = array.size(trade_pnls) - 1 to 0
        if array.get(trade_pnls, i) > 0
            current_win_streak += 1
            if current_win_streak > max_win_streak
                max_win_streak := current_win_streak
        else
            current_win_streak := 0

// Ù…ØªÙˆØ³Ø· R Ø§Ù„Ù…Ø­Ù‚Ù‚ (Average R Achieved)
float avg_r_achieved = na
if array.size(trade_rr_achieved) > 0
    float sum_rr = 0.0
    int valid_c  = 0
    for i = 0 to array.size(trade_rr_achieved) - 1
        float rr = array.get(trade_rr_achieved, i)
        if not na(rr)
            sum_rr += rr
            valid_c += 1
    if valid_c > 0
        avg_r_achieved := sum_rr / valid_c

// Ù…Ù„Ø®Øµ Ø¢Ø®Ø± 5 ØµÙÙ‚Ø§Øª
get_recent_trades_summary(int count) =>
    string summary = ""
    if array.size(trade_pnls) >= 1
        int recent_wins = 0
        float recent_pnl = 0.0
        int bars_calc = math.min(count, array.size(trade_pnls))
        for i = array.size(trade_pnls) - bars_calc to array.size(trade_pnls) - 1
            float pnl = array.get(trade_pnls, i)
            recent_pnl += pnl
            if pnl > 0
                recent_wins += 1
        summary := str.tostring(recent_wins) + "/" + str.tostring(bars_calc) + " " + 
                   txt("Ù†Ø§Ø¬Ø­Ø©", "Win") + " | " + 
                   embed_number(recent_pnl, "#,###")
    summary

// Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØµØºØ± (Mini Equity Chart)
get_equity_mini_chart(int bars_to_show) =>
    string chart = ""
    if array.size(trade_pnls) >= 2
        int bars = math.min(bars_to_show, array.size(trade_pnls))
        float max_pnl = array.max(trade_pnls)
        float min_pnl = array.min(trade_pnls)
        float range_pnl = max_pnl - min_pnl
        if range_pnl > 0
            for i = array.size(trade_pnls) - bars to array.size(trade_pnls) - 1
                float pnl = array.get(trade_pnls, i)
                int height = int((pnl - min_pnl) / range_pnl * 5)
                if height >= 4
                    chart += "â–ˆ"
                else if height >= 3
                    chart += "â–†"
                else if height >= 2
                    chart += "â–„"
                else if height >= 1
                    chart += "â–‚"
                else
                    chart += "â–"
        else
            for i = 0 to bars - 1
                chart += "â–„"
    chart

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Portfolio Heat & Market Exposure
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

float portfolio_heat = enable_position_sizing and not na(calculated_position_size) and not na(risk_amount_calc) ? safe_div((calculated_position_size * risk_amount_calc), account_capital, 0.0) * 100.0 : 0.0

int total_bars_in_trades = 0
if array.size(trade_bars_held) > 0
    for i = 0 to array.size(trade_bars_held) - 1
        total_bars_in_trades += array.get(trade_bars_held, i)
float market_exposure = bar_index > 0 ? safe_div(total_bars_in_trades * 100.0, bar_index, 0.0) : 0.0

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MFE/MAE Tracking (Ù„Ù„ØµÙÙ‚Ø© Ø§Ù„Ø­ÙŠØ©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var float ref_entry_price = na
var float ref_sl_price    = na
var float trade_highest   = na
var float trade_lowest    = na
var float mfe_r           = na
var float mae_r           = na

if barstate.isconfirmed and FINAL_BUY
    ref_entry_price := entry_price
    ref_sl_price    := sl_price
    trade_highest   := c
    trade_lowest    := c
    mfe_r           := 0.0
    mae_r           := 0.0

if not na(entry_bar)
    trade_highest := na(trade_highest) ? h : math.max(trade_highest, h)
    trade_lowest  := na(trade_lowest)  ? l : math.min(trade_lowest, l)
    float risk_ps = (ref_entry_price > 0 and not na(ref_sl_price)) ? (ref_entry_price - ref_sl_price) : na
    if not na(risk_ps) and risk_ps > 0
        mfe_r := (trade_highest - ref_entry_price) / risk_ps
        mae_r := (ref_entry_price - trade_lowest) / risk_ps
else
    trade_highest := na
    trade_lowest  := na
    mfe_r         := na
    mae_r         := na
    ref_entry_price := na
    ref_sl_price    := na

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Setup Quality Calculator
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

calc_setup_quality() =>
    int quality = 0
    
    if ema_bull_aligned
        if price_above_all_ema
            quality += QUALITY_EMA_BULL_ABOVE
        else
            quality += QUALITY_EMA_BULL
    
    quality += int(mtf_bullish_count * QUALITY_MTF_PER_TF)
    
    if vol_bullish
        if vol_extreme
            quality += QUALITY_VOL_EXTREME
        else if vol_very_high
            quality += QUALITY_VOL_VHIGH
        else
            quality += QUALITY_VOL_BULL
    
    if touching_support
        quality += QUALITY_SUPPORT_TOUCH
    if in_golden_zone
        quality += QUALITY_GOLDEN_ZONE
    
    if rsi_bullish_zone and adx_strong
        quality += QUALITY_RSI_ADX_BOTH
    else if rsi_bullish_zone or adx_strong
        quality += QUALITY_RSI_ADX_SINGLE
    
    if any_buy_trigger
        quality += QUALITY_TRIGGER_MINOR
    
    math.min(quality, 100)

int setup_quality = calc_setup_quality()

// Trade Grade (A+ to F)
get_trade_grade(float quality, float score) =>
    string grade = "F"
    color col = BAD
    if quality >= 90 and score >= 75
        grade := "A+"
        col := color.new(GOOD, 0)
    else if quality >= 80 and score >= 65
        grade := "A"
        col := color.new(GOOD, 20)
    else if quality >= 70 and score >= 55
        grade := "B"
        col := WARN
    else if quality >= 60 and score >= 45
        grade := "C"
        col := color.orange
    else if quality >= 50 and score >= 35
        grade := "D"
        col := color.new(BAD, 40)
    [grade, col]

[trade_grade, grade_color] = get_trade_grade(setup_quality, final_score)

// Confluence Counter
calc_confluence() =>
    int conf = 0
    if ema_bull_aligned
        conf += 1
    if mtf_aligned_bullish
        conf += 1
    if adx_strong
        conf += 1
    if vol_bullish
        conf += 1
    if touching_support or in_golden_zone
        conf += 1
    if rsi_bullish_zone
        conf += 1
    if above_vwap
        conf += 1
    if rs_trend_bullish
        conf += 1
    conf

int confluence = calc_confluence()

// Probability of Success
calc_probability_of_success() =>
    float prob = 50.0
    
    if bt_total_trades >= 20
        prob := bt_win_rate
    
    if setup_quality >= 90
        prob += PROB_QUALITY_90
    else if setup_quality >= 80
        prob += PROB_QUALITY_80
    else if setup_quality >= 70
        prob += PROB_QUALITY_70
    else if setup_quality < 50
        prob += PROB_QUALITY_LOW
    
    if mtf_all_bullish
        prob += PROB_MTF_ALL_BULL
    else if mtf_bearish_count >= 4
        prob += PROB_MTF_BEAR_HIGH
    
    if regime_is_healthy
        prob += PROB_REGIME_HEALTHY
    else
        prob += PROB_REGIME_POOR
    
    if not na(rr_value) and rr_value >= 3.0
        prob += PROB_RR_HIGH
    
    math.max(20, math.min(95, prob))

float probability = calc_probability_of_success()

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ØªØ­Ø¯ÙŠØ« Cached Values
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if barstate.isconfirmed
    cached_atr_ratio := atr_ratio
    
    if vwap_active and vwap_val != 0
        cached_vwap_dist := safe_div((c - vwap_val), vwap_val, 0.0) * 100.0
    else
        cached_vwap_dist := na
    
    [temp_prof, temp_col] = classify_stock_profile(adx_val, atr_ratio)
    cached_stock_profile := temp_prof
    cached_profile_color := temp_col
    
    [temp_str, temp_tcol] = get_market_temp(volatile_extreme, atr_ratio, dead_market)
    cached_market_temp := temp_str
    cached_temp_color := temp_tcol
    
    cached_setup_quality := setup_quality
    cached_trade_grade := trade_grade
    cached_grade_color := grade_color
    cached_confluence := confluence
    cached_probability := probability
    cached_sortino := bt_sortino
    cached_calmar := bt_calmar
    cached_avg_r := avg_r_achieved
    cached_recent_summary := get_recent_trades_summary(5)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Equity Curve (Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø±ØµÙŠØ¯)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_EQUITY = txt("ðŸ“ˆ Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø±ØµÙŠØ¯", "ðŸ“ˆ Equity Curve")
show_equity_curve = input.bool(false, txt("Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø­Ù†Ù‰ Equity","Show Equity Curve"), 
     group=G_EQUITY)
plot(show_equity_curve and enable_backtesting ? bt_equity : na,       
     title=txt("Ø§Ù„Ø±ØµÙŠØ¯","Equity"),          
     color=color.purple, 
     linewidth=2)
plot(show_equity_curve and enable_backtesting ? account_capital : na, 
     title=txt("Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠ","Initial Capital"), 
     color=color.new(color.gray, 60), 
     linewidth=1, 
     style=plot.style_line)
plot(show_equity_curve and enable_backtesting ? bt_peak_equity : na,  
     title=txt("Ø£Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯","Peak Equity"),     
     color=color.new(GOOD, 70), 
     linewidth=1, 
     style=plot.style_stepline)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª (Entry/SL/Targets + S/R + Patterns)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_LINES = txt("ðŸŽ¨ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª", "ðŸŽ¨ Lines & Shapes")
show_trade_lines         = input.bool(true,  txt("Ø®Ø·ÙˆØ· Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ÙˆÙ‚Ù/Ø§Ù„Ø£Ù‡Ø¯Ø§Ù","Entry/SL/Targets Lines"), 
     group=G_LINES)
show_sr_lines            = input.bool(true,  txt("Ø®Ø·ÙˆØ· Ø¯/Ù…","S/R Lines"), 
     group=G_LINES)
show_chart_patterns_disp = input.bool(true,  txt("Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø±Øª","Patterns on Chart"), 
     group=G_LINES)

bool show_lines = (FINAL_BUY or confirmed_buy_signal) and sl_valid

plot(show_trade_lines and show_lines ? entry_price : na, 
     title=txt("Ø§Ù„Ø¯Ø®ÙˆÙ„","Entry"),     
     color=color.new(color.blue, 20),  
     style=plot.style_linebr, 
     linewidth=2)
plot(show_trade_lines and show_lines ? sl_price    : na, 
     title=txt("ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©","Stop Loss"), 
     color=color.new(BAD, 10),         
     style=plot.style_linebr, 
     linewidth=3)
plot(show_trade_lines and show_lines ? t1_price    : na, 
     title=txt("Ø§Ù„Ù‡Ø¯Ù 1","Target 1"),        
     color=color.new(GOOD, 20),        
     style=plot.style_linebr, 
     linewidth=2)
plot(show_trade_lines and show_lines ? t2_price    : na, 
     title=txt("Ø§Ù„Ù‡Ø¯Ù 2","Target 2"),        
     color=color.new(color.lime, 20),  
     style=plot.style_linebr, 
     linewidth=2)
plot(show_trade_lines and show_lines ? t3_price    : na, 
     title=txt("Ø§Ù„Ù‡Ø¯Ù 3","Target 3"),        
     color=color.new(color.green, 30), 
     style=plot.style_linebr, 
     linewidth=1)

plot(show_sr_lines ? nearest_support    : na, 
     title=txt("Ø§Ù„Ø¯Ø¹Ù…","Support"),    
     color=color.new(GOOD, 60), 
     style=plot.style_circles, 
     linewidth=1)
plot(show_sr_lines ? nearest_resistance : na, 
     title=txt("Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©","Resistance"), 
     color=color.new(BAD, 60),  
     style=plot.style_circles, 
     linewidth=1)

plotchar(show_chart_patterns_disp and double_bottom,     
     title=txt("Ù‚Ø§Ø¹ Ù…Ø²Ø¯ÙˆØ¬","Double Bottom"),     
     char="W", 
     location=location.belowbar, 
     color=GOOD, 
     size=size.small)
plotchar(show_chart_patterns_disp and double_top,        
     title=txt("Ù‚Ù…Ø© Ù…Ø²Ø¯ÙˆØ¬Ø©","Double Top"),        
     char="M", 
     location=location.abovebar, 
     color=BAD,  
     size=size.small)
plotchar(show_chart_patterns_disp and hammer,            
     title=txt("Ø§Ù„Ù…Ø·Ø±Ù‚Ø©","Hammer"),            
     char="H", 
     location=location.belowbar, 
     color=GOOD, 
     size=size.tiny)
plotchar(show_chart_patterns_disp and shooting_star,     
     title=txt("Ø§Ù„Ø´Ù‡Ø§Ø¨","Shooting Star"),     
     char="S", 
     location=location.abovebar, 
     color=BAD,  
     size=size.tiny)
plotchar(show_chart_patterns_disp and bullish_engulfing, 
     title=txt("Ø§Ø¨ØªÙ„Ø§Ø¹ Ø´Ø±Ø§Ø¦ÙŠ","Bullish Engulfing"), 
     char="â–²", 
     location=location.belowbar, 
     color=GOOD, 
     size=size.small)
plotchar(show_chart_patterns_disp and bearish_engulfing, 
     title=txt("Ø§Ø¨ØªÙ„Ø§Ø¹ Ø¨ÙŠØ¹ÙŠ","Bearish Engulfing"), 
     char="â–¼", 
     location=location.abovebar, 
     color=BAD,  
     size=size.small)
plotchar(show_chart_patterns_disp and gap_up_detected,   
     title=txt("ÙØ¬ÙˆØ© ØµØ§Ø¹Ø¯Ø©","Gap Up"),            
     char="â†‘", 
     location=location.belowbar, 
     color=color.aqua,   
     size=size.tiny)
plotchar(show_chart_patterns_disp and gap_down_detected, 
     title=txt("ÙØ¬ÙˆØ© Ù‡Ø§Ø¨Ø·Ø©","Gap Down"),          
     char="â†“", 
     location=location.abovebar, 
     color=color.orange, 
     size=size.tiny)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ±Ø³Ù… Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_SHAPES = txt("ðŸŽ¯ ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª", "ðŸŽ¯ Shape Cooldown")
shape_cooldown_bars = input.int(6, txt("ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (Ø´Ù…ÙˆØ¹)","Shape Cooldown Bars"), 
     minval=0, 
     maxval=50, 
     group=G_SHAPES)
var int last_buy_shape_bar  = na
var int last_sell_shape_bar = na

bool show_buy_shape  = FINAL_BUY  and (na(last_buy_shape_bar)  or (bar_index - last_buy_shape_bar  >= shape_cooldown_bars))
bool show_sell_shape = FINAL_SELL and (na(last_sell_shape_bar) or (bar_index - last_sell_shape_bar >= shape_cooldown_bars))

if barstate.isconfirmed
    if show_buy_shape
        last_buy_shape_bar := bar_index
    if show_sell_shape
        last_sell_shape_bar := bar_index

plotshape(msg_lang == "AR" and show_buy_shape,  
     title="BUY AR",  
     style=shape.labelup,   
     location=location.belowbar, 
     color=color.new(GOOD, 0), 
     text=use_emojis ? "ðŸš€ Ø´Ø±Ø§Ø¡" : "Ø´Ø±Ø§Ø¡", 
     textcolor=color.white, 
     size=size.small)
plotshape(msg_lang == "AR" and show_sell_shape, 
     title="SELL AR", 
     style=shape.labeldown, 
     location=location.abovebar, 
     color=color.new(BAD, 0),  
     text=use_emojis ? "ðŸ”» Ø¨ÙŠØ¹" : "Ø¨ÙŠØ¹",  
     textcolor=color.white, 
     size=size.small)

plotshape(msg_lang == "EN" and show_buy_shape,  
     title="BUY EN",  
     style=shape.labelup,   
     location=location.belowbar, 
     color=color.new(GOOD, 0), 
     text=use_emojis ? "ðŸš€ BUY" : "BUY",  
     textcolor=color.white, 
     size=size.small)
plotshape(msg_lang == "EN" and show_sell_shape, 
     title="SELL EN", 
     style=shape.labeldown, 
     location=location.abovebar, 
     color=color.new(BAD, 0),  
     text=use_emojis ? "ðŸ”» SELL" : "SELL", 
     textcolor=color.white, 
     size=size.small)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø­Ø³Ø§Ø¨ Signal Strength
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

bool sr_context_for_strength = touching_support or in_golden_zone
int signal_strength = calc_signal_strength(ema_bull_aligned, mtf_aligned_bullish, adx_strong, vol_bullish, sr_context_for_strength, rsi_bullish_zone, any_buy_trigger)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MTF Icons String (Ù„Ù„Ù€ Console)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var string mtf_icons_cached = ""
if barstate.islast and use_mtf
    mtf_icons_cached := ""
    mtf_icons_cached += mtf_trend_1 > 0 ? (use_emojis ? "ðŸŸ¢" : "â–²") : mtf_trend_1 < 0 ? (use_emojis ? "ðŸ”´" : "â–¼") : (use_emojis ? "âšª" : "â€¢")
    mtf_icons_cached += mtf_trend_2 > 0 ? (use_emojis ? "ðŸŸ¢" : "â–²") : mtf_trend_2 < 0 ? (use_emojis ? "ðŸ”´" : "â–¼") : (use_emojis ? "âšª" : "â€¢")
    mtf_icons_cached += mtf_trend_3 > 0 ? (use_emojis ? "ðŸŸ¢" : "â–²") : mtf_trend_3 < 0 ? (use_emojis ? "ðŸ”´" : "â–¼") : (use_emojis ? "âšª" : "â€¢")
    mtf_icons_cached += mtf_trend_4 > 0 ? (use_emojis ? "ðŸŸ¢" : "â–²") : mtf_trend_4 < 0 ? (use_emojis ? "ðŸ”´" : "â–¼") : (use_emojis ? "âšª" : "â€¢")
    mtf_icons_cached += mtf_trend_5 > 0 ? (use_emojis ? "ðŸŸ¢" : "â–²") : mtf_trend_5 < 0 ? (use_emojis ? "ðŸ”´" : "â–¼") : (use_emojis ? "âšª" : "â€¢")
    mtf_icons_cached += mtf_trend_6 > 0 ? (use_emojis ? "ðŸŸ¢" : "â–²") : mtf_trend_6 < 0 ? (use_emojis ? "ðŸ”´" : "â–¼") : (use_emojis ? "âšª" : "â€¢")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¹Ø±Ø¶
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

get_signal_text(float score) =>
    string e_rocket = use_emojis ? "ðŸš€ " : ""
    string e_strong = use_emojis ? "ðŸ’ª " : ""
    string e_ok     = use_emojis ? "âœ… " : ""
    string e_warn   = use_emojis ? "âš ï¸ " : ""
    string e_stop   = use_emojis ? "ðŸ›‘ " : ""
    string e_boom   = use_emojis ? "ðŸ’¥ " : ""
    string e_neut   = use_emojis ? "âšª " : ""
    string res = ""
    if score >= 85
        res := e_rocket + txt("Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹", "Very Strong BUY")
    else if score >= 70
        res := e_strong + txt("Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ", "Strong BUY")
    else if score >= 55
        res := e_ok + txt("Ø´Ø±Ø§Ø¡", "BUY")
    else if score >= 35
        res := e_ok + txt("Ø´Ø±Ø§Ø¡ Ø¶Ø¹ÙŠÙ", "Weak BUY")
    else if score <= -85
        res := e_boom + txt("Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹", "Very Strong SELL")
    else if score <= -70
        res := e_stop + txt("Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ", "Strong SELL")
    else if score <= -55
        res := e_warn + txt("Ø¨ÙŠØ¹", "SELL")
    else if score <= -35
        res := e_warn + txt("Ø¨ÙŠØ¹ Ø¶Ø¹ÙŠÙ", "Weak SELL")
    else
        res := e_neut + txt("Ù…Ø­Ø§ÙŠØ¯", "Neutral")
    res

get_signal_color(float score) =>
    color col = NEUTRAL
    if score >= 70
        col := GOOD
    else if score >= 55
        col := color.new(GOOD, 30)
    else if score >= 35
        col := WARN
    else if score <= -70
        col := BAD
    else if score <= -55
        col := color.new(BAD, 30)
    else if score <= -35
        col := WARN
    col

get_advice_emoji() =>
    FINAL_SELL ? (use_emojis ? "ðŸšª" : "") : 
    FINAL_BUY ? (cached_probability >= 70 ? (use_emojis ? "âœ…" : "") : (use_emojis ? "ðŸŸ¢" : "")) : 
    (use_emojis ? "ðŸ“Œ" : "")

get_advice_type() =>
    FINAL_SELL ? txt("ØªØ­Ø°ÙŠØ±", "Warning") :
    FINAL_BUY ? txt("ØªÙˆØµÙŠØ©", "Recommendation") :
    txt("Ù…Ù„Ø­ÙˆØ¸Ø©", "Note")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø¡ 6/7
// ØªÙ… Ø¥Ø¶Ø§ÙØ©:
// âœ… Performance Metrics (Sharpe, Sortino, Calmar, Recovery Factor, Avg R, Win/Lose Streaks)
// âœ… Portfolio Heat & Market Exposure
// âœ… MFE/MAE Tracking (Ø¨Ø§Ù„Ù€R)
// âœ… Setup Quality Calculator (0-100)
// âœ… Trade Grade (A+ to F)
// âœ… Confluence Counter (0-8)
// âœ… Probability of Success (20%-95%)
// âœ… Equity Curve Visual
// âœ… ÙƒÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª (Entry/SL/Targets, S/R, Patterns)
// âœ… Signal Shapes (Ù…Ø¹ ØªØ¨Ø±ÙŠØ¯)
// âœ… Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¹Ø±Ø¶
// âœ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Cached Values
// 
// Build-Blockers Safe âœ“ | Visual Helpers Complete âœ“
// 
// Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ø¬Ø²Ø¡ 7/7 (Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© + Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª + Ø§Ù„Ø³Ø±Ø¯ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¬Ø²Ø¡ 7/7 (Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ): Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© + Ø§Ù„Ø³Ø±Ø¯ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ + Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
// v14.0 ULTIMATE - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ø³Ø±Ø¯ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Dynamic Narrative)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

build_dynamic_scenario() =>
    string scenario = ""
    
    if FINAL_SELL
        if exit_support_break
            scenario := txt(
                "ÙƒØ³Ø± Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø­Ø¬Ù… Ù‚ÙˆÙŠ. Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù‡Ø§Ø¨Ø· Ù…ØªÙˆÙ‚Ø¹ Ù†Ø­Ùˆ ",
                "Main support broken with volume. Correction expected to "
            ) + embed_number(calc_max_drop(), format.mintick) + txt(" Ø¬.Ù….", " EGP.")
        else if exit_ema50_cross
            scenario := txt(
                "ÙƒØ³Ø± EMA50 Ù‡Ø¨ÙˆØ·Ø§Ù‹ Ù…Ø¹ Ù‚ÙˆØ© Ø§ØªØ¬Ø§Ù‡. Ø®Ø±ÙˆØ¬ ÙÙˆØ±ÙŠ Ù…ÙˆØµÙ‰ Ø¨Ù‡.",
                "EMA50 broken down with ADX strength. Immediate exit advised."
            )
        else
            scenario := txt(
                "Ø¥Ø´Ø§Ø±Ø§Øª ÙÙ†ÙŠØ© Ø³Ù„Ø¨ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø©. Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù…Ù† Ø£ÙˆÙ„ÙˆÙŠØ©.",
                "Multiple bearish signals. Safe exit is priority."
            )
    
    else if FINAL_BUY
        if touching_support and in_golden_zone
            scenario := txt(
                "Ø§Ø±ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù‚ÙˆÙŠ. Ø§Ù„ØµØ¹ÙˆØ¯ Ù†Ø­Ùˆ ",
                "Bounce from golden zone and support. Rally to "
            ) + embed_number(t1_price, format.mintick) + txt(
                " Ø¬.Ù… Ù…ØªÙˆÙ‚Ø¹ Ø¨Ù‚ÙˆØ©. Ø§Ù„Ø«Ø¨Ø§Øª Ø£Ø¹Ù„Ù‰ ",
                " EGP expected. Holding above "
            ) + embed_number(nearest_support, format.mintick) + txt(
                " Ø¬.Ù… ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±.",
                " EGP confirms continuation."
            )
        else if resistance_broken
            scenario := txt(
                "Ø§Ø®ØªØ±Ø§Ù‚ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø¨Ø­Ø¬Ù… Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠ. Ø§Ù„Ø²Ø®Ù… Ø§Ù„ØµØ¹ÙˆØ¯ÙŠ Ù‚ÙˆÙŠ Ù†Ø­Ùˆ ",
                "Resistance breakout with exceptional volume. Strong momentum to "
            ) + embed_number(t2_price, format.mintick) + txt(" Ø¬.Ù….", " EGP.")
        else if mtf_all_bullish
            scenario := txt(
                "ØªÙˆØ§ÙÙ‚ ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø·Ø± Ø§Ù„Ø²Ù…Ù†ÙŠØ©. Ø­Ø±ÙƒØ© ØµØ§Ø¹Ø¯Ø© Ù…Ø¤ÙƒØ¯Ø© Ù†Ø­Ùˆ Ù‚Ù…Ù… Ø¬Ø¯ÙŠØ¯Ø©.",
                "Full MTF alignment. Confirmed uptrend to new highs."
            )
        else
            scenario := txt(
                "Ø¥Ø´Ø§Ø±Ø§Øª ÙÙ†ÙŠØ© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ù‚ÙˆÙŠØ©. Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù† ÙØ±ØµØ© Ø¬ÙŠØ¯Ø© Ù„Ø§Ø³ØªÙ‡Ø¯Ø§Ù ",
                "Strong bullish signals. Entry now targets "
            ) + embed_number(t1_price, format.mintick) + txt(" Ø¬.Ù….", " EGP.")
    
    else
        if ema_bull_aligned and not rr_acceptable
            scenario := txt(
                "Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ù„ÙƒÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©/Ø§Ù„Ø¹Ø§Ø¦Ø¯ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©. Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ø³Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙØ¶Ù„.",
                "Trend positive but R:R unfavorable. Waiting for better entry is safer."
            )
        else if mtf_bearish_count >= 4
            scenario := txt(
                "ØªÙˆØ§ÙÙ‚ Ù‡Ø§Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø·Ø± Ø§Ù„Ø£Ø¹Ù„Ù‰. ØªØ¬Ù†Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø­ØªÙ‰ Ø¸Ù‡ÙˆØ± ØªØ­Ø³Ù† ÙˆØ§Ø¶Ø­.",
                "Bearish MTF alignment. Avoid buying until clear improvement."
            )
        else if dead_market
            scenario := txt(
                "Ø§Ù„Ø³ÙˆÙ‚ Ø®Ø§Ù…Ù„ Ø¨Ù„Ø§ Ø­Ø¬Ù…. Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ù†Ø´Ø§Ø· ÙˆØ§Ø¶Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø±Ø§Ø±.",
                "Market dead with no volume. Wait for clear activity."
            )
        else
            scenario := txt(
                "Ø­Ø±ÙƒØ© Ø¹Ø±Ø¶ÙŠØ©. Ø§Ù„Ø£ÙØ¶Ù„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯Ø¹Ù…/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ù„Ø­ÙŠÙ† Ø¸Ù‡ÙˆØ± Ø§ØªØ¬Ø§Ù‡ ÙˆØ§Ø¶Ø­.",
                "Sideways. Watch S/R until clear direction emerges."
            )
    
    scenario

build_dynamic_advice() =>
    string advice = ""
    
    if FINAL_SELL
        advice := txt(
            "Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙÙˆØ±ÙŠ Ø¶Ø±ÙˆØ±ÙŠ. Ø­Ù…Ø§ÙŠØ© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø£ÙˆÙ„ÙˆÙŠØ© Ù‚ØµÙˆÙ‰.",
            "Immediate exit necessary. Capital protection is top priority."
        )
    
    else if FINAL_BUY
        if cached_probability >= 70
            advice := txt(
                "ÙØ±ØµØ© Ù‚ÙˆÙŠØ© Ø¨Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ù†Ø¬Ø§Ø­ ",
                "Strong opportunity with "
            ) + embed_number(cached_probability, "#") + txt(
                "%. Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù† Ù…Ø¹ ÙˆÙ‚Ù Ø¹Ù†Ø¯ ",
                "% probability. Enter now with SL at "
            ) + embed_number(sl_price, format.mintick) + txt(" Ø¬.Ù….", " EGP.")
        else
            advice := txt(
                "Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ù…Ø¹ØªØ¯Ù„Ø©. Ø¬Ù†ÙŠ Ø£Ø±Ø¨Ø§Ø­ ØªØ¯Ø±ÙŠØ¬ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ù…ÙˆØµÙ‰ Ø¨Ù‡.",
                "Moderate buy signal. Gradual profit taking at targets advised."
            )
    
    else if cooldown_active
        advice := txt(
            "ØªØ¨Ø±ÙŠØ¯ Ù†Ø´Ø· Ø¨Ø¹Ø¯ Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©. Ø§Ù„ØµØ¨Ø± Ø­ØªÙ‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØªØ±Ø© Ø£ÙØ¶Ù„.",
            "Cooldown active after last signal. Patience until period ends is better."
        )
    
    else
        advice := txt(
            "Ù„Ø§ ØªÙˆØµÙŠØ© ÙˆØ§Ø¶Ø­Ø© Ø§Ù„Ø¢Ù†. Ù…ØªØ§Ø¨Ø¹Ø© ØªØ·ÙˆØ±Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ø¶Ø±ÙˆØ±ÙŠØ©.",
            "No clear recommendation now. Following market developments necessary."
        )
    
    advice

generate_narrative_v2() =>
    string nl = "\n"
    string narr = ""
    
    narr += txt("ØªØ­Ø¯ÙŠØ« Ø³Ù‡Ù… ", "Update: ") + syminfo.ticker + " - EGX" + nl
    narr += get_timeframe_ar() + " | " + get_current_date() + nl
    narr += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" + nl
    
    narr += txt("ðŸ“Š Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©:", "ðŸ“Š Key Levels:") + nl
    if not na(nearest_support)
        string sup_stars = get_support_stars()
        narr += "â–ª " + txt("Ø§Ù„Ø¯Ø¹Ù…: ", "Support: ") + 
                embed_number(nearest_support, format.mintick) + txt(" Ø¬.Ù… ", " EGP ") + 
                sup_stars + nl
    if not na(nearest_resistance)
        narr += "â–ª " + txt("Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: ", "Resistance: ") + 
                embed_number(nearest_resistance, format.mintick) + txt(" Ø¬.Ù…", " EGP") + nl
    float max_drop = calc_max_drop()
    if not na(max_drop)
        narr += "â–ª " + txt("Ø£Ù‚ØµÙ‰ Ø§Ù†Ø®ÙØ§Ø¶ Ù…ØªÙˆÙ‚Ø¹: ", "Max Drop Expected: ") + 
                embed_number(max_drop, format.mintick) + txt(" Ø¬.Ù…", " EGP") + nl
    narr += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" + nl
    
    narr += txt("ðŸŽ¯ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:", "ðŸŽ¯ Expected Scenario:") + nl
    narr += build_dynamic_scenario() + nl
    narr += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" + nl
    
    string advice_emoji = get_advice_emoji()
    string advice_type = get_advice_type()
    narr += advice_emoji + " " + advice_type + ":" + nl
    narr += build_dynamic_advice() + nl
    
    rtl_embed(narr)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ§  Ø§Ù„Ù„ÙˆØ­Ø© 1: Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ (Control & Analysis Panel)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if barstate.islast
    if show_control_panel and na(control_table)
        control_table := table.new(control_pos, 4, 16, bgcolor=PANEL_BG, border_width=2, border_color=PANEL_BORDER)

    if show_control_panel and not na(control_table)
        int r = 0
        
        string header = (use_emojis ? "ðŸ§  " : "") + "EGX PRO v14.0"
        table.cell(control_table, 0, r, rtl_embed(header), bgcolor=ACCENT, text_color=color.white, text_halign=to_align_center(), text_size=control_font)
        string tkr = syminfo.ticker + " Â· " + timeframe.period
        table.cell(control_table, 1, r, rtl_embed(tkr), bgcolor=ACCENT, text_color=color.white, text_halign=to_align_center(), text_size=control_font)
        string sh_txt = is_sharia_compliant ? (use_emojis ? "âœ… " : "") + txt("Ù…ØªÙˆØ§ÙÙ‚", "OK") : (use_emojis ? "âŒ " : "") + txt("ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚", "NOT OK")
        table.cell(control_table, 2, r, rtl_embed(sh_txt), bgcolor=is_sharia_compliant ? GOOD : BAD, text_color=color.white, text_halign=to_align_center(), text_size=control_font)
        string ses = in_preopen ? txt("Ù…Ø§ Ù‚Ø¨Ù„", "Pre") : in_opening ? txt("Ø§ÙØªØªØ§Ø­", "Open") : in_regular ? txt("Ø¹Ø§Ø¯ÙŠØ©", "Reg") : in_closing ? txt("Ø¥ØºÙ„Ø§Ù‚", "Close") : txt("Ø®Ø§Ø±Ø¬", "Off")
        table.cell(control_table, 3, r, rtl_embed((use_emojis ? "ðŸ•’ " : "") + ses), bgcolor=INFO, text_color=color.white, text_halign=to_align_center(), text_size=control_font)
        r += 1

        table.cell(control_table, 0, r, rtl_embed(txt("Ø§Ù„Ø¯Ø±Ø¬Ø©", "Score")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        color sig_col = get_signal_color(final_score)
        table.cell(control_table, 1, r, rtl_embed(embed_number(final_score, "#") + "/100"), bgcolor=sig_col, text_color=color.white, text_halign=to_align_center(), text_size=control_font)
        string score_gauge_vis = get_score_gauge(final_score, 8)
        table.cell(control_table, 2, r, rtl_embed(score_gauge_vis), text_color=TEXT_MAIN, text_halign=to_align(), text_size=control_font)
        string liq = not enable_liquidity_filter ? txt("Ù…ØªÙˆÙ‚Ù", "OFF") : (liquidity_ok and spread_ok ? (use_emojis ? "âœ… " : "") + txt("Ø¬ÙŠØ¯", "OK") : (use_emojis ? "âš ï¸ " : "") + txt("Ø¶Ø¹ÙŠÙ", "Weak"))
        table.cell(control_table, 3, r, rtl_embed(liq), text_color=liquidity_ok and spread_ok ? GOOD : WARN, text_halign=to_align_center(), text_size=control_font)
        r += 1

        table.cell(control_table, 0, r, rtl_embed(txt("Ø§Ù„Ø³Ø¹Ø±", "Price")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 1, r, rtl_embed(embed_number(c, format.mintick)), text_color=TEXT_MAIN, text_halign=to_align_center(), text_size=control_font)
        string vtext = "N/A"
        if vwap_active and not na(cached_vwap_dist)
            string dir = above_vwap ? txt("ÙÙˆÙ‚ ", "Above ") : txt("ØªØ­Øª ", "Below ")
            vtext := dir + "VWAP (" + embed_number(cached_vwap_dist, "#.##") + "%)"
        table.cell(control_table, 2, r, rtl_embed(vtext), text_color=TEXT_MAIN, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 3, r, rtl_embed("RSI:" + embed_number(rsi_val, "#")), text_color=TEXT_MAIN, text_halign=to_align_center(), text_size=control_font)
        r += 1

        table.cell(control_table, 0, r, rtl_embed(txt("Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø³ÙˆÙ‚", "Market Temp")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 1, r, rtl_embed(cached_market_temp), text_color=cached_temp_color, text_halign=to_align_center(), text_size=control_font)
        string strength_bar = get_signal_strength_bar(signal_strength, 10)
        table.cell(control_table, 2, r, rtl_embed(txt("Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©", "Signal Strength")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 3, r, rtl_embed(strength_bar), text_color=TEXT_MAIN, text_halign=to_align(), text_size=control_font)
        r += 1

        if use_mtf
            table.cell(control_table, 0, r, rtl_embed(use_emojis ? "ðŸ”„ MTF" : "MTF"), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
            string mtf_summary = txt("â†‘:", "â†‘:") + str.tostring(mtf_bullish_count) + "/6 Â· " + txt("â†“:", "â†“:") + str.tostring(mtf_bearish_count) + "/6"
            table.cell(control_table, 1, r, rtl_embed(mtf_summary), text_color=TEXT_MAIN, text_halign=to_align(), text_size=control_font)
            table.cell(control_table, 2, r, rtl_embed(mtf_icons_cached), text_color=TEXT_MAIN, text_halign=to_align_center(), text_size=control_font)
            string reg = regime_is_healthy ? (use_emojis ? "âœ… " : "") + market_regime : (use_emojis ? "âš ï¸ " : "") + market_regime
            table.cell(control_table, 3, r, rtl_embed(reg), text_color=regime_is_healthy ? GOOD : WARN, text_halign=to_align_center(), text_size=control_font)
            r += 1

        table.cell(control_table, 0, r, rtl_embed(txt("Ø¯Ø¹Ù…", "Support")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 1, r, rtl_embed(na(nearest_support) ? "-" : embed_number(nearest_support, format.mintick) + txt(" Ø¬.Ù…", " EGP")), text_color=GOOD, text_halign=to_align_center(), text_size=control_font)
        table.cell(control_table, 2, r, rtl_embed(txt("Ù…Ù‚Ø§ÙˆÙ…Ø©", "Resistance")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 3, r, rtl_embed(na(nearest_resistance) ? "-" : embed_number(nearest_resistance, format.mintick) + txt(" Ø¬.Ù…", " EGP")), text_color=BAD, text_halign=to_align_center(), text_size=control_font)
        r += 1

        table.cell(control_table, 0, r, rtl_embed(txt("ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©", "Stop Loss")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 1, r, rtl_embed(na(sl_price) ? "-" : embed_number(sl_price, format.mintick)), bgcolor=color.new(BAD, 85), text_color=BAD, text_halign=to_align_center(), text_size=control_font)
        table.cell(control_table, 2, r, rtl_embed(txt("Ø§Ù„Ø£Ù‡Ø¯Ø§Ù", "Targets")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        string targets_line = "T1:" + (na(t1_price) ? "-" : embed_number(t1_price, format.mintick))
        table.cell(control_table, 3, r, rtl_embed(targets_line), text_color=TEXT_MAIN, text_halign=to_align(), text_size=control_font)
        r += 1

        string rr1_text = na(rr_t1) ? "-" : embed_number(rr_t1, "#.##")
        table.cell(control_table, 0, r, rtl_embed(txt("Ù…/Ø¹ (Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©/Ø§Ù„Ø¹Ø§Ø¦Ø¯)", "R:R (Risk/Reward)")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 1, r, rtl_embed("T1:" + rr1_text), text_color=(not na(rr_t1) and rr_t1 >= rr_threshold) ? GOOD : WARN, text_halign=to_align_center(), text_size=control_font)
        string signal_display = FINAL_BUY ? (use_emojis ? "âœ… " : "") + txt("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¢Ù†", "BUY now") : FINAL_SELL ? (use_emojis ? "ðŸšª " : "") + txt("Ø§Ø®Ø±Ø¬ Ø§Ù„Ø¢Ù†", "EXIT now") : (use_emojis ? "ðŸ“Œ " : "") + txt("Ø§Ù†ØªØ¸Ø±", "Wait")
        table.cell(control_table, 2, r, rtl_embed(txt("Ø§Ù„ØªÙˆØµÙŠØ©", "Action")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 3, r, rtl_embed(signal_display), bgcolor=color.new(get_signal_color(final_score), 80), text_color=TEXT_MAIN, text_halign=to_align_center(), text_size=control_font)
        r += 1

        table.cell(control_table, 0, r, rtl_embed((use_emojis ? "ðŸ¤– " : "") + txt("Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø§Ø­", "Success Probability")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        color prob_color = cached_probability >= 70 ? GOOD : cached_probability >= 50 ? WARN : BAD
        table.cell(control_table, 1, r, rtl_embed(embed_number(cached_probability, "#") + "%"), bgcolor=prob_color, text_color=color.white, text_halign=to_align_center(), text_size=control_font)
        string prob_bar = draw_progress_bar(cached_probability, 100, 8)
        table.cell(control_table, 2, r, rtl_embed(prob_bar), text_color=TEXT_MAIN, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 3, r, "", text_color=TEXT_MAIN)
        r += 1

        table.cell(control_table, 0, r, rtl_embed(txt("Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…", "Stock Profile")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        table.cell(control_table, 1, r, rtl_embed(cached_stock_profile), text_color=cached_profile_color, text_halign=to_align_center(), text_size=control_font)
        table.cell(control_table, 2, r, rtl_embed(txt("Ø£ÙØ¶Ù„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©", "Best Strategy")), text_color=TEXT_SUB, text_halign=to_align(), text_size=control_font)
        string best_strat = ""
        if cached_stock_profile == txt("ØªØ±Ù†Ø¯ Ù‚ÙˆÙŠ Ù…ØªÙ‚Ù„Ø¨", "Strong Trending Volatile")
            best_strat := txt("Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§ØªØ¬Ø§Ù‡", "Trend Following")
        else if cached_stock_profile == txt("ØªØ±Ù†Ø¯ Ù…Ø³ØªÙ‚Ø±", "Stable Trending")
            best_strat := txt("ØªØ¯Ø§ÙˆÙ„ ÙŠÙˆÙ…ÙŠ", "Day Trading")
        else if cached_stock_profile == txt("Ù†Ø·Ø§Ù‚ Ø¶ÙŠÙ‚", "Tight Range")
            best_strat := txt("Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ Ù„Ù„Ù…ØªÙˆØ³Ø·", "Mean Reversion")
        else if cached_stock_profile == txt("Ù…ØªÙ‚Ù„Ø¨ Ø¨Ù„Ø§ Ø§ØªØ¬Ø§Ù‡", "Choppy Volatile")
            best_strat := txt("Ø§Ù†ØªØ¸Ø±", "Wait")
        else
            best_strat := txt("Ù†Ù‡Ø¬ Ù…ØªÙˆØ§Ø²Ù†", "Balanced")
        table.cell(control_table, 3, r, rtl_embed(best_strat), text_color=TEXT_MAIN, text_halign=to_align(), text_size=control_font)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“‹ Ø§Ù„Ù„ÙˆØ­Ø© 2: Ø§Ù„Ø³Ø±Ø¯ ÙˆØ§Ù„Ø®Ø·Ø© (Narrative & Plan Panel)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if barstate.islast
    int rows_narr = compact_mode ? 6 : 12
    if show_narrative_panel and na(narrative_table)
        narrative_table := table.new(narrative_pos, 1, rows_narr, bgcolor=PANEL_BG, border_width=2, border_color=PANEL_BORDER)
    
    if show_narrative_panel and not na(narrative_table)
        string narr_header = (use_emojis ? "ðŸ“‹ " : "") + txt("Ø§Ù„Ø³Ø±Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ", "Narrative Analysis")
        table.cell(narrative_table, 0, 0, rtl_embed(narr_header), bgcolor=INFO, text_color=color.white, text_halign=to_align_center(), text_size=narrative_font)
        string narrative_content = generate_narrative_v2()
        table.cell(narrative_table, 0, 1, narrative_content, bgcolor=color.new(get_signal_color(final_score), 92), text_color=TEXT_MAIN, text_halign=to_align(), text_size=narrative_font)
        for nr = 2 to rows_narr - 1
            table.cell(narrative_table, 0, nr, "", text_color=TEXT_MAIN, text_halign=to_align(), text_size=narrative_font)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“ˆ Ø§Ù„Ù„ÙˆØ­Ø© 3: Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± (Performance & Risk Panel)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if barstate.islast and enable_backtesting
    if show_performance_panel and na(performance_table)
        performance_table := table.new(performance_pos, 2, 14, bgcolor=PANEL_BG, border_width=2, border_color=PANEL_BORDER)
    
    if show_performance_panel and not na(performance_table)
        int pr = 0
        string perf_header = (use_emojis ? "ðŸ’¹ " : "") + txt("Ø§Ù„Ø£Ø¯Ø§Ø¡", "Performance")
        table.cell(performance_table, 0, pr, rtl_embed(perf_header), bgcolor=ACCENT, text_color=color.white, text_halign=to_align_center(), text_size=performance_font)
        string risk_header = (use_emojis ? "ðŸ›¡ï¸ " : "") + txt("Ø§Ù„Ù…Ø®Ø§Ø·Ø±", "Risk")
        table.cell(performance_table, 1, pr, rtl_embed(risk_header), bgcolor=ACCENT2, text_color=color.white, text_halign=to_align_center(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ø§Ù„Ø±ØµÙŠØ¯", "Equity")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color eq_col = bt_equity >= account_capital ? GOOD : BAD
        table.cell(performance_table, 0, pr, rtl_embed(embed_number(bt_equity, "#,###")), text_color=eq_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ %", "Win Rate %")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color wr_col = bt_win_rate >= 60 ? GOOD : bt_win_rate >= 50 ? WARN : BAD
        string wr_bar = draw_progress_bar(bt_win_rate, 100, 8)
        table.cell(performance_table, 1, pr, rtl_embed(embed_number(bt_win_rate, "#") + "% " + wr_bar), text_color=wr_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¨Ø­", "Profit Factor")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color pf_col = nz(bt_profit_factor, 0) >= 2.0 ? GOOD : nz(bt_profit_factor, 0) >= 1.5 ? WARN : BAD
        table.cell(performance_table, 1, pr, rtl_embed(na(bt_profit_factor) ? "-" : embed_number(bt_profit_factor, "#.##")), text_color=pf_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ù†Ø³Ø¨Ø© Ø´Ø§Ø±Ø¨ (Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ø§Ø¦Ø¯)", "Sharpe Ratio")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color sh_col = not na(bt_sharpe) and bt_sharpe >= 1.0 ? GOOD : not na(bt_sharpe) and bt_sharpe >= 0.5 ? WARN : BAD
        table.cell(performance_table, 1, pr, rtl_embed(na(bt_sharpe) ? "-" : embed_number(bt_sharpe, "#.##")), text_color=sh_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ù†Ø³Ø¨Ø© Ø³ÙˆØ±ØªÙŠÙ†Ùˆ", "Sortino Ratio")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color so_col = not na(cached_sortino) and cached_sortino >= 1.0 ? GOOD : not na(cached_sortino) and cached_sortino >= 0.5 ? WARN : BAD
        table.cell(performance_table, 1, pr, rtl_embed(na(cached_sortino) ? "-" : embed_number(cached_sortino, "#.##")), text_color=so_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ù†Ø³Ø¨Ø© ÙƒØ§Ù„Ù…Ø§Ø± (Ø§Ù„Ø¹Ø§Ø¦Ø¯/Ø§Ù„ØªØ±Ø§Ø¬Ø¹)", "Calmar Ratio")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color ca_col = not na(cached_calmar) and cached_calmar >= 3.0 ? GOOD : not na(cached_calmar) and cached_calmar >= 1.5 ? WARN : BAD
        table.cell(performance_table, 1, pr, rtl_embed(na(cached_calmar) ? "-" : embed_number(cached_calmar, "#.##")), text_color=ca_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ù…ØªÙˆØ³Ø· R (Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©)", "Avg R")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color ar_col = not na(cached_avg_r) and cached_avg_r >= 2.0 ? GOOD : not na(cached_avg_r) and cached_avg_r >= 1.0 ? WARN : BAD
        table.cell(performance_table, 1, pr, rtl_embed(na(cached_avg_r) ? "-" : embed_number(cached_avg_r, "#.##") + "R"), text_color=ar_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ø£Ù‚ØµÙ‰ ØªØ±Ø§Ø¬Ø¹ %", "Max Drawdown %")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color dd_color = bt_max_dd < 10 ? GOOD : bt_max_dd < 20 ? WARN : BAD
        table.cell(performance_table, 1, pr, rtl_embed(embed_number(bt_max_dd, "#.##") + "%"), text_color=dd_color, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©)", "Portfolio Heat")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        [heat_gauge_str, heat_gauge_col] = get_risk_gauge(portfolio_heat)
        table.cell(performance_table, 1, pr, rtl_embed(heat_gauge_str + " (" + embed_number(portfolio_heat, "#.#") + "%)"), text_color=heat_gauge_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        float live_r = (not na(entry_bar) and not na(risk_amount_calc) and risk_amount_calc > 0) ? (c - entry_price) / risk_amount_calc : na
        table.cell(performance_table, 0, pr, rtl_embed(txt("Ø§Ù„Ù€R Ø§Ù„Ø­ÙŠ (Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)", "Live R")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        color live_r_col = not na(live_r) and live_r > 0 ? GOOD : not na(live_r) and live_r < 0 ? BAD : NEUTRAL
        table.cell(performance_table, 1, pr, rtl_embed(na(live_r) ? "-" : embed_number(live_r, "#.##") + "R"), text_color=live_r_col, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ø£Ù‚ØµÙ‰ Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø© (R)", "MFE/MAE (R)")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        string mfe_mae = (na(mfe_r) ? "-" : embed_number(mfe_r, "#.##")) + " / " + (na(mae_r) ? "-" : embed_number(mae_r, "#.##"))
        table.cell(performance_table, 1, pr, rtl_embed(mfe_mae), text_color=TEXT_MAIN, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ø§Ù„ØªØ¹Ø±Ø¶ Ù„Ù„Ø³ÙˆÙ‚ %", "Market Exposure %")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        string exp_graph = get_exposure_graph(market_exposure, 10)
        table.cell(performance_table, 1, pr, rtl_embed(exp_graph), text_color=TEXT_MAIN, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ø¢Ø®Ø± 5 ØµÙÙ‚Ø§Øª", "Recent 5 Trades")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        table.cell(performance_table, 1, pr, rtl_embed(cached_recent_summary), text_color=TEXT_MAIN, text_halign=to_align(), text_size=performance_font)
        pr += 1

        table.cell(performance_table, 0, pr, rtl_embed(txt("Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØµØºØ±", "Mini Equity Chart")), text_color=TEXT_SUB, text_halign=to_align(), text_size=performance_font)
        string mini_eq = get_equity_mini_chart(10)
        table.cell(performance_table, 1, pr, rtl_embed(mini_eq), text_color=TEXT_MAIN, text_halign=to_align(), text_size=performance_font)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Š Ø§Ù„Ù„ÙˆØ­Ø© 4: Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„ (Reports & Legend Panel)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if barstate.islast
    if show_reports_panel and na(reports_table)
        reports_table := table.new(reports_pos, 3, 12, bgcolor=PANEL_BG, border_width=2, border_color=PANEL_BORDER)
    
    if show_reports_panel and not na(reports_table)
        int rr = 0
        string rep_header = (use_emojis ? "ðŸ“Š " : "") + txt("Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", "Reports")
        table.cell(reports_table, 0, rr, rtl_embed(rep_header), bgcolor=INFO, text_color=color.white, text_halign=to_align_center(), text_size=reports_font)
        table.cell(reports_table, 1, rr, rtl_embed(txt("Ø§Ù„Ù‚ÙŠÙ…", "Values")), bgcolor=INFO, text_color=color.white, text_halign=to_align_center(), text_size=reports_font)
        string legend_hdr = (use_emojis ? "ðŸ“– " : "") + txt("Ø§Ù„Ø¯Ù„ÙŠÙ„", "Legend")
        table.cell(reports_table, 2, rr, rtl_embed(legend_hdr), bgcolor=INFO, text_color=color.white, text_halign=to_align_center(), text_size=reports_font)
        rr += 1

        table.cell(reports_table, 0, rr, rtl_embed(txt("Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯", "Setup Quality")), text_color=TEXT_SUB, text_halign=to_align(), text_size=reports_font)
        string quality_bar = draw_progress_bar(cached_setup_quality, 100, 8)
        table.cell(reports_table, 1, rr, rtl_embed(str.tostring(cached_setup_quality) + "/100 " + quality_bar), text_color=TEXT_MAIN, text_halign=to_align(), text_size=reports_font)
        string POS = txt("Ø¥ÙŠØ¬Ø§Ø¨ÙŠ", "Bullish")
        table.cell(reports_table, 2, rr, rtl_embed("W = " + txt("Ù‚Ø§Ø¹ Ù…Ø²Ø¯ÙˆØ¬", "Double Bottom") + " (" + POS + ")"), text_color=GOOD, text_halign=to_align(), text_size=reports_font)
        rr += 1

        table.cell(reports_table, 0, rr, rtl_embed(txt("Ø§Ù„ØªØµÙ†ÙŠÙ", "Grade")), text_color=TEXT_SUB, text_halign=to_align(), text_size=reports_font)
        table.cell(reports_table, 1, rr, rtl_embed(cached_trade_grade), bgcolor=cached_grade_color, text_color=color.white, text_halign=to_align_center(), text_size=reports_font)
        string NEG = txt("Ø³Ù„Ø¨ÙŠ", "Bearish")
        table.cell(reports_table, 2, rr, rtl_embed("M = " + txt("Ù‚Ù…Ø© Ù…Ø²Ø¯ÙˆØ¬Ø©", "Double Top") + " (" + NEG + ")"), text_color=BAD, text_halign=to_align(), text_size=reports_font)
        rr += 1

        table.cell(reports_table, 0, rr, rtl_embed(txt("Ø§Ù„ØªÙˆØ§ÙÙ‚", "Confluence")), text_color=TEXT_SUB, text_halign=to_align(), text_size=reports_font)
        string conf_bar = draw_progress_bar(cached_confluence, 8, 8)
        table.cell(reports_table, 1, rr, rtl_embed(str.tostring(cached_confluence) + "/8 " + conf_bar), text_color=TEXT_MAIN, text_halign=to_align(), text_size=reports_font)
        table.cell(reports_table, 2, rr, rtl_embed("H = " + txt("Ø§Ù„Ù…Ø·Ø±Ù‚Ø©", "Hammer") + " (" + POS + ")"), text_color=GOOD, text_halign=to_align(), text_size=reports_font)
        rr += 1

        table.cell(reports_table, 0, rr, rtl_embed(txt("Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©", "Probability")), text_color=TEXT_SUB, text_halign=to_align(), text_size=reports_font)
        color prob_vis_col = cached_probability >= 70 ? GOOD : cached_probability >= 50 ? WARN : BAD
        table.cell(reports_table, 1, rr, rtl_embed(embed_number(cached_probability, "#") + "%"), bgcolor=prob_vis_col, text_color=color.white, text_halign=to_align_center(), text_size=reports_font)
        table.cell(reports_table, 2, rr, rtl_embed("S = " + txt("Ø§Ù„Ø´Ù‡Ø§Ø¨", "Shooting Star") + " (" + NEG + ")"), text_color=BAD, text_halign=to_align(), text_size=reports_font)
        rr += 1

        table.cell(reports_table, 0, rr, rtl_embed(txt("Ø§Ù„Ø®Ø·Ø©", "Plan")), text_color=TEXT_SUB, text_halign=to_align(), text_size=reports_font)
        string plan_line = txt("Ø¯Ø®ÙˆÙ„:", "Entry:") + (sl_valid ? embed_number(entry_price, format.mintick) : "-")
        table.cell(reports_table, 1, rr, rtl_embed(plan_line), text_color=TEXT_MAIN, text_halign=to_align(), text_size=reports_font)
        table.cell(reports_table, 2, rr, rtl_embed("â–² = " + txt("Ø§Ø¨ØªÙ„Ø§Ø¹ Ø´Ø±Ø§Ø¦ÙŠ", "Bullish Engulf") + " (" + POS + ")"), text_color=GOOD, text_halign=to_align(), text_size=reports_font)
        rr += 1

        if not na(sl_price)
            string sl_line = txt("ÙˆÙ‚Ù:", "SL:") + embed_number(sl_price, format.mintick)
            table.cell(reports_table, 0, rr, rtl_embed(sl_line), text_color=TEXT_SUB, text_halign=to_align(), text_size=reports_font)
        if not na(rr_value)
            string rr_line = txt("Ù…/Ø¹:", "R:R:") + embed_number(rr_value, "#.##")
            table.cell(reports_table, 1, rr, rtl_embed(rr_line), text_color=TEXT_MAIN, text_halign=to_align(), text_size=reports_font)
        table.cell(reports_table, 2, rr, rtl_embed("â–¼ = " + txt("Ø§Ø¨ØªÙ„Ø§Ø¹ Ø¨ÙŠØ¹ÙŠ", "Bearish Engulf") + " (" + NEG + ")"), text_color=BAD, text_halign=to_align(), text_size=reports_font)
        rr += 1

        if enable_position_sizing
            table.cell(reports_table, 0, rr, rtl_embed(txt("Ø­Ø¬Ù… Ø§Ù„ØµÙÙ‚Ø©", "Position Size")), text_color=TEXT_SUB, text_halign=to_align(), text_size=reports_font)
            string ps_line = (na(calculated_position_size) ? "-" : str.tostring(calculated_position_size, "#")) + txt(" Ø³Ù‡Ù…", " shares")
            table.cell(reports_table, 1, rr, rtl_embed(ps_line), text_color=TEXT_MAIN, text_halign=to_align(), text_size=reports_font)
        table.cell(reports_table, 2, rr, rtl_embed("â†‘ = " + txt("ÙØ¬ÙˆØ© ØµØ§Ø¹Ø¯Ø©", "Gap Up") + " (" + POS + ")"), text_color=color.aqua, text_halign=to_align(), text_size=reports_font)
        rr += 1

        if enable_backtesting
            table.cell(reports_table, 0, rr, rtl_embed(txt("ØµÙÙ‚Ø§Øª", "Trades") + " (BT)"), text_color=TEXT_SUB, text_halign=to_align(), text_size=reports_font)
            string bt_line = str.tostring(bt_total_trades) + " | Win:" + embed_number(bt_win_rate, "#") + "%"
            color bt_color = bt_total_pnl > 0 ? GOOD : bt_total_pnl < 0 ? BAD : NEUTRAL
            table.cell(reports_table, 1, rr, rtl_embed(bt_line), text_color=bt_color, text_halign=to_align(), text_size=reports_font)
        table.cell(reports_table, 2, rr, rtl_embed("â†“ = " + txt("ÙØ¬ÙˆØ© Ù‡Ø§Ø¨Ø·Ø©", "Gap Down") + " (" + NEG + ")"), text_color=color.orange, text_halign=to_align(), text_size=reports_font)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Alerts)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_ALERTS = txt("ðŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª", "ðŸ”” Alerts")
enable_alerts_buy  = input.bool(true,  txt("ØªÙ†Ø¨ÙŠÙ‡: Ø´Ø±Ø§Ø¡", "Alert: BUY"), group=G_ALERTS)
enable_alerts_sell = input.bool(true,  txt("ØªÙ†Ø¨ÙŠÙ‡: Ø¨ÙŠØ¹", "Alert: SELL"), group=G_ALERTS)
enable_alerts_t1   = input.bool(true,  txt("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù‡Ø¯Ù 1", "Alert: T1"), group=G_ALERTS)
enable_alerts_sl   = input.bool(true,  txt("ØªÙ†Ø¨ÙŠÙ‡: ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©", "Alert: SL"), group=G_ALERTS)

build_buy_alert_message() =>
    string emoji = use_emojis ? "ðŸš€ " : ""
    string buy_txt = txt("Ø´Ø±Ø§Ø¡", "BUY")
    string msg = "EGX Pro v14.0 | " + emoji + buy_txt + " | " + syminfo.ticker + " @" + str.tostring(c, format.mintick) + "\n"
    msg += txt("Ø§Ù„Ø¯Ø±Ø¬Ø©: ", "Score: ") + str.tostring(final_score, "#") + "/100 | "
    msg += txt("Ø¬ÙˆØ¯Ø©: ", "Quality: ") + str.tostring(cached_setup_quality) + "/100 | "
    msg += txt("ØªØµÙ†ÙŠÙ: ", "Grade: ") + cached_trade_grade + "\n"
    msg += txt("ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: ", "SL: ") + (na(sl_price) ? "-" : str.tostring(sl_price, format.mintick)) + " | "
    msg += "T1: " + (na(t1_price) ? "-" : str.tostring(t1_price, format.mintick)) + " (R:R " + (na(rr_t1) ? "-" : str.tostring(rr_t1, "#.##")) + ")" + "\n"
    msg += txt("Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©: ", "Probability: ") + str.tostring(cached_probability, "#") + "%"
    msg

build_sell_alert_message() =>
    string reason = exit_support_break ? txt("ÙƒØ³Ø± Ø¯Ø¹Ù…", "Support Break") : exit_ema50_cross ? "EMA50â†“" : exit_vwap_loss ? "VWAPâ†“" : txt("Ø®Ø±ÙˆØ¬", "Exit")
    string emoji = use_emojis ? "ðŸ”» " : ""
    string sell_txt = txt("Ø¨ÙŠØ¹", "SELL")
    string reason_txt = txt("Ø§Ù„Ø³Ø¨Ø¨: ", "Reason: ")
    "EGX Pro v14.0 | " + emoji + sell_txt + " | " + syminfo.ticker + " @" + str.tostring(c, format.mintick) + " | " + reason_txt + reason

bool t1_hit_alert = not na(t1_price) and not na(entry_bar) and h >= t1_price and nz(h[1]) < t1_price
bool sl_hit_alert = not na(sl_price) and not na(entry_bar) and l <= sl_price and nz(l[1]) > sl_price

if barstate.isconfirmed
    if enable_alerts_buy and FINAL_BUY
        alert(build_buy_alert_message(), alert.freq_once_per_bar_close)
    if enable_alerts_sell and FINAL_SELL
        alert(build_sell_alert_message(), alert.freq_once_per_bar_close)
    if enable_alerts_t1 and t1_hit_alert
        alert("EGX Pro v14.0 | " + txt("Ø§Ù„Ù‡Ø¯Ù 1", "T1") + " | " + syminfo.ticker + " @" + str.tostring(t1_price, format.mintick), alert.freq_once_per_bar_close)
    if enable_alerts_sl and sl_hit_alert
        alert("EGX Pro v14.0 | " + txt("ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©", "SL") + " | " + syminfo.ticker + " @" + str.tostring(sl_price, format.mintick), alert.freq_once_per_bar_close)

alertcondition(FINAL_BUY,     title=txt("Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡","BUY Signal"),  message="{{ticker}} - BUY @ {{close}}")
alertcondition(FINAL_SELL,    title=txt("Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹","SELL Signal"), message="{{ticker}} - SELL @ {{close}}")
alertcondition(t1_hit_alert,  title=txt("Ø§Ù„Ù‡Ø¯Ù 1","T1 Reached"),  message="{{ticker}} - T1 @ {{high}}")
alertcondition(sl_hit_alert,  title=txt("ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©","SL Hit"),      message="{{ticker}} - SL @ {{low}}")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ”— Webhooks (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

string G_WEBHOOK = txt("ðŸ”— Webhook", "ðŸ”— Webhook")
enable_webhooks = input.bool(false, txt("ØªÙØ¹ÙŠÙ„ Webhooks","Enable Webhooks"), group=G_WEBHOOK)

build_webhook_json(string signal_type) =>
    string json = "{\n"
    json += '  "ticker": "' + syminfo.ticker + '",\n'
    json += '  "signal": "' + signal_type + '",\n'
    json += '  "price": ' + str.tostring(c, format.mintick) + ',\n'
    json += '  "score": ' + str.tostring(final_score, "#.##") + ',\n'
    json += '  "quality": ' + str.tostring(cached_setup_quality) + ',\n'
    json += '  "grade": "' + cached_trade_grade + '",\n'
    json += '  "probability": ' + str.tostring(cached_probability, "#.##") + ',\n'
    json += '  "stop_loss": ' + (na(sl_price) ? "null" : str.tostring(sl_price, format.mintick)) + ',\n'
    json += '  "target_1": ' + (na(t1_price) ? "null" : str.tostring(t1_price, format.mintick)) + ',\n'
    json += '  "target_2": ' + (na(t2_price) ? "null" : str.tostring(t2_price, format.mintick)) + ',\n'
    json += '  "target_3": ' + (na(t3_price) ? "null" : str.tostring(t3_price, format.mintick)) + ',\n'
    json += '  "rr_t1": ' + (na(rr_t1) ? "null" : str.tostring(rr_t1, "#.##")) + ',\n'
    json += '  "position_size": ' + (na(calculated_position_size) ? "null" : str.tostring(calculated_position_size, "#")) + ',\n'
    json += '  "stock_profile": "' + cached_stock_profile + '"\n'
    json += "}"
    json

if barstate.isconfirmed and enable_webhooks
    if FINAL_BUY
        alert(build_webhook_json("BUY"), alert.freq_once_per_bar_close)
    if FINAL_SELL
        alert(build_webhook_json("SELL"), alert.freq_once_per_bar_close)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸŽ‰ Ù†Ù‡Ø§ÙŠØ© EGX Pro v14.0 ULTIMATE - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 
// âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 
// ðŸ“¦ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙØ·Ø¨Ù‚Ø© (100%):
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âœ… 4 Ù„ÙˆØ­Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 7)
//    1. ðŸ§  Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ (Control & Analysis) - 16 ØµÙ
//    2. ðŸ“‹ Ø§Ù„Ø³Ø±Ø¯ ÙˆØ§Ù„Ø®Ø·Ø© (Narrative & Plan) - 12 ØµÙ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
//    3. ðŸ’¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± (Performance & Risk) - 14 ØµÙ
//    4. ðŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„ (Reports & Legend) - 12 ØµÙ
// 
// âœ… Ø§Ù„Ø³Ø±Ø¯ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (100% ÙˆØ§Ù‚Ø¹ÙŠ):
//    - build_dynamic_scenario() (4 Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©)
//    - build_dynamic_advice() (5 Ù†ØµØ§Ø¦Ø­ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
//    - Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ (21 Ù†ÙˆÙÙ…Ø¨Ø± 2025)
//    - Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ù€ RTL Safe (\u200E)
//    - Ø§Ù„Ù†Ø¬ÙˆÙ… â­â­â­ Ù„Ù‚ÙˆØ© Ø§Ù„Ø¯Ø¹Ù…
// 
// âœ… Ø§Ù„ØªØ¹Ø±ÙŠØ¨ Ø§Ù„ÙƒØ§Ù…Ù„ (50+ ÙƒÙ„Ù…Ø©):
//    - ÙƒÙ„ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„ÙÙ†ÙŠØ© Ù…ÙØ¹Ø±Ø¨Ø©
//    - Ø´Ø±ÙˆØ­Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ (Ù…Ø«Ù„: "Ù†Ø³Ø¨Ø© Ø´Ø§Ø±Ø¨ (Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ø§Ø¦Ø¯)")
//    - Ù„Ø§ ÙƒÙ„Ù…Ø§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
// 
// âœ… Ø¥ØµÙ„Ø§Ø­Ø§Øª Build-Blockers (100%):
//    - âœ… No Repainting (ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± [1])
//    - âœ… ÙƒÙ„ ta.* Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø±ÙˆØ·
//    - âœ… S/R Arrays Ù…Ø­Ø¯ÙˆØ¯Ø© (100 max)
//    - âœ… Trailing Stop reset Ø¹Ù†Ø¯ Exit
//    - âœ… Dynamic Slippage (5 Ø¹ÙˆØ§Ù…Ù„)
//    - âœ… Polarity Check (Ù…Ù†Ø¹ Ø§Ù„ØªÙ†Ø§Ù‚Ø¶Ø§Øª)
//    - âœ… 50+ Constants (Ù„Ø§ Magic Numbers)
// 
// âœ… Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (15+):
//    - Sharpe, Sortino, Calmar, Recovery Factor
//    - Portfolio Heat, Market Exposure
//    - MFE/MAE, Win/Lose Streaks, T-Hit Rate
//    - Setup Quality (0-100), Trade Grade (A+-F)
//    - Confluence (0-8), Probability (20%-95%)
// 
// âœ… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ù€ Webhooks:
//    - 4 ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (BUY, SELL, T1, SL)
//    - Webhooks JSON ÙƒØ§Ù…Ù„
//    - Ø±Ø³Ø§Ø¦Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ/Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
// 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 
// Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø·Ø±: ~2,340 Ø³Ø·Ø±
// Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡: 7 Ø£Ø¬Ø²Ø§Ø¡ Ù…ØªÙ†Ø§Ø³Ù‚Ø©
// Ø§Ù„Ø¬Ø²Ø¡ 1: 330 Ø³Ø·Ø± (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª + Ø§Ù„Ù„ØºØ© + Constants)
// Ø§Ù„Ø¬Ø²Ø¡ 2: 300 Ø³Ø·Ø± (Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©)
// Ø§Ù„Ø¬Ø²Ø¡ 3: 320 Ø³Ø·Ø± (MTF + Regime + Sessions)
// Ø§Ù„Ø¬Ø²Ø¡ 4: 350 Ø³Ø·Ø± (Ø§Ù„Ø£Ù†Ù…Ø§Ø· + S/R + ÙØ§ÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ + Ø§Ù„ØªÙ‚ÙŠÙŠÙ…)
// Ø§Ù„Ø¬Ø²Ø¡ 5: 380 Ø³Ø·Ø± (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø© + Ø§Ù„Ø¨Ø§Ùƒâ€‘ØªØ³Øª)
// Ø§Ù„Ø¬Ø²Ø¡ 6: 280 Ø³Ø·Ø± (Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø£Ø¯Ø§Ø¡ + Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª)
// Ø§Ù„Ø¬Ø²Ø¡ 7: 340 Ø³Ø·Ø± (Ø§Ù„Ù„ÙˆØ­Ø§Øª + Ø§Ù„Ø³Ø±Ø¯ + Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª)
// 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙƒØ«Ø± ØªÙ‚Ø¯Ù…Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ù„Ù„Ø¨ÙˆØ±ØµØ© Ø§Ù„Ù…ØµØ±ÙŠØ©!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 
// Developed with â¤ï¸ for Egyptian Exchange Traders
// v14.0 ULTIMATE - Build-Blockers Compliant âœ“ | RTL Safe âœ“ | No Repainting âœ“
// 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
